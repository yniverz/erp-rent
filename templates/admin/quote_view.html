{% extends "admin/base.html" %}

{% block title %}Angebot {{ quote.reference_number }} - Verwaltung{% endblock %}

{% block content %}
<div class="actions-bar">
    <h1 class="m-0 flex-1">Angebot: {{ quote.reference_number }}</h1>
    <span class="badge badge-{{ quote.status }} badge-lg">{{ {'draft':'Entwurf','finalized':'Finalisiert','performed':'Durchgef√ºhrt','paid':'Bezahlt'}.get(quote.status, quote.status|capitalize) }}</span>
</div>

<div class="card">
    <div class="form-row">
        <div>
            <p><strong>Kunde:</strong> {{ quote.customer_name }}</p>
            {% if quote.recipient_lines %}
                <p class="text-muted text-pre-line">{{ quote.recipient_lines }}</p>
            {% endif %}
        </div>
        <div>
            <p><strong>Zeitraum:</strong>
                {% if quote.start_date and quote.end_date %}
                    {{ quote.start_date.strftime('%d.%m.%Y') }} ‚Äì {{ quote.end_date.strftime('%d.%m.%Y') }}
                    ({{ quote.calculate_rental_days() }} Tag{{ 'e' if quote.calculate_rental_days() != 1 }})
                {% else %}
                    Nicht gesetzt
                {% endif %}
            </p>
            <p><strong>Referenz:</strong> {{ quote.reference_number }}</p>
            <p><strong>Erstellt:</strong> {{ quote.created_at.strftime('%d.%m.%Y %H:%M') }} von {{ quote.created_by.display_name or quote.created_by.username if quote.created_by else '‚Äî' }}</p>
            {% if quote.status in ['finalized', 'performed', 'paid'] and quote.finalized_at %}
            <p><strong>Finalisiert:</strong> {{ quote.finalized_at.strftime('%d.%m.%Y %H:%M') }}
                {% if quote.status in ['finalized', 'performed', 'paid'] %}
                <button type="button" class="btn btn-sm btn-outline" id="edit-finalized-date-btn" onclick="document.getElementById('edit-finalized-date').style.display='flex';this.style.display='none';" style="margin-left:6px;padding:3px 8px;font-size:0.8em;">‚úèÔ∏è Datum √§ndern</button>
                {% endif %}
            </p>
            {% if quote.status in ['finalized', 'performed', 'paid'] %}
            <div id="edit-finalized-date" style="display:none;align-items:center;gap:6px;margin-top:6px;">
                <form method="POST" action="{{ url_for('admin.quote_update_finalized_date', quote_id=quote.id) }}" style="display:flex;align-items:center;gap:6px;">
                    <input type="date" name="finalized_at" value="{{ quote.finalized_at.strftime('%Y-%m-%d') }}" required style="padding:4px 8px;font-size:0.85em;">
                    <button type="submit" class="btn btn-sm btn-success" style="padding:3px 10px;">Speichern</button>
                    <button type="button" class="btn btn-sm btn-outline" style="padding:3px 10px;" onclick="document.getElementById('edit-finalized-date').style.display='none';document.getElementById('edit-finalized-date-btn').style.display='';">Abbrechen</button>
                </form>
            </div>
            {% endif %}
            {% endif %}
            {% if quote.status in ['performed', 'paid'] and quote.performed_at %}
            <p><strong>Durchgef√ºhrt:</strong> {{ quote.performed_at.strftime('%d.%m.%Y %H:%M') }}
                {% if quote.status in ['performed', 'paid'] %}
                <button type="button" class="btn btn-sm btn-outline" id="edit-performed-date-btn" onclick="document.getElementById('edit-performed-date').style.display='flex';this.style.display='none';" style="margin-left:6px;padding:3px 8px;font-size:0.8em;">‚úèÔ∏è Datum √§ndern</button>
                {% endif %}
            </p>
            {% if quote.status in ['performed', 'paid'] %}
            <div id="edit-performed-date" style="display:none;align-items:center;gap:6px;margin-top:6px;">
                <form method="POST" action="{{ url_for('admin.quote_update_performed_date', quote_id=quote.id) }}" style="display:flex;align-items:center;gap:6px;">
                    <input type="date" name="performed_at" value="{{ quote.performed_at.strftime('%Y-%m-%d') }}" required style="padding:4px 8px;font-size:0.85em;">
                    <button type="submit" class="btn btn-sm btn-success" style="padding:3px 10px;">Speichern</button>
                    <button type="button" class="btn btn-sm btn-outline" style="padding:3px 10px;" onclick="document.getElementById('edit-performed-date').style.display='none';document.getElementById('edit-performed-date-btn').style.display='';">Abbrechen</button>
                </form>
            </div>
            {% endif %}
            {% endif %}
            {% if quote.status == 'paid' and quote.paid_at %}
            <p><strong>Bezahlt:</strong> {{ quote.paid_at.strftime('%d.%m.%Y %H:%M') }}
                {% if quote.payment_method == 'cash' %}(Bar){% elif quote.payment_method == 'bank' %}(√úberweisung){% endif %}
                {% if quote.status == 'paid' %}
                <button type="button" class="btn btn-sm btn-outline" id="edit-paid-date-btn" onclick="document.getElementById('edit-paid-date').style.display='flex';this.style.display='none';" style="margin-left:6px;padding:3px 8px;font-size:0.8em;">‚úèÔ∏è Datum √§ndern</button>
                {% endif %}
            </p>
            {% if quote.status == 'paid' %}
            <div id="edit-paid-date" style="display:none;align-items:center;gap:6px;margin-top:6px;">
                <form method="POST" action="{{ url_for('admin.quote_update_paid_date', quote_id=quote.id) }}" style="display:flex;align-items:center;gap:6px;">
                    <input type="date" name="paid_at" value="{{ quote.paid_at.strftime('%Y-%m-%d') }}" required style="padding:4px 8px;font-size:0.85em;">
                    <button type="submit" class="btn btn-sm btn-success" style="padding:3px 10px;">Speichern</button>
                    <button type="button" class="btn btn-sm btn-outline" style="padding:3px 10px;" onclick="document.getElementById('edit-paid-date').style.display='none';document.getElementById('edit-paid-date-btn').style.display='';">Abbrechen</button>
                </form>
            </div>
            {% endif %}
            {% endif %}
        </div>
    </div>

    {% if quote.notes %}
        <p class="mt-14"><strong>Notizen:</strong></p>
        <p class="text-muted text-pre-line">{{ quote.notes }}</p>
    {% endif %}
</div>

<!-- Items -->
<div class="card">
    <h2>Artikel</h2>
    <table>
        <thead>
            <tr><th>Artikel</th><th>Eigent√ºmer</th><th>Menge</th><th>Preis/Tag</th><th>Kosten/Tag</th><th>Summe</th></tr>
        </thead>
        <tbody>
            {% set package_items = quote.quote_items|selectattr('package_id')|list %}
            {% set package_ids = package_items|map(attribute='package_id')|unique|list %}
            {% set shown_ids = [] %}

            {% for qi in quote.quote_items %}
                {% if qi.package_id and qi.package_id not in shown_ids %}
                    {% set pkg_components = package_items|selectattr('package_id', 'equalto', qi.package_id)|list %}
                    {% if shown_ids.append(qi.package_id) %}{% endif %}
                    <tr class="package-header-row">
                        <td colspan="5">
                            <strong>üì¶ {{ qi.package.name }}</strong>
                            <span class="badge badge-package">Paket</span>
                        </td>
                        <td>&euro;{{ "%.2f"|format(pkg_components|sum(attribute='total_price')) }}</td>
                    </tr>
                    {% for pqi in pkg_components %}
                    <tr class="package-component-row">
                        <td class="pl-30">
                            ‚Ü≥ {{ pqi.display_name }}
                            {% if pqi.item and pqi.item.is_external %}
                                <small class="text-external">&#x2197; Extern</small>
                            {% endif %}
                            {% if pqi.discount_exempt and quote.discount_percent > 0 %}
                                <br><small class="text-warning">Kein Rabatt</small>
                            {% endif %}
                        </td>
                        <td>‚Äî</td>
                        <td>{{ pqi.quantity }}</td>
                        <td>&euro;{{ "%.2f"|format(pqi.rental_price_per_day) }}</td>
                        <td>
                            {% if pqi.rental_cost_per_day %}
                                &euro;{{ "%.2f"|format(pqi.rental_cost_per_day) }}
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </td>
                        <td>
                            &euro;{{ "%.2f"|format(pqi.total_price) }}
                            {% if pqi.rental_cost_per_day %}
                                <br><small class="text-danger">Kosten: &euro;{{ "%.2f"|format(pqi.total_external_cost) }}</small>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                {% elif not qi.package_id %}
                <tr>
                    <td>
                        {{ qi.display_name }}
                        {% if qi.item and qi.item.is_external %}
                            <small class="text-external">&#x2197; Extern</small>
                        {% endif %}
                        {% if qi.discount_exempt and quote.discount_percent > 0 %}
                            <br><small class="text-warning">Kein Rabatt</small>
                        {% endif %}
                    </td>
                    <td>‚Äî</td>
                    <td>{{ qi.quantity }}</td>
                    <td>&euro;{{ "%.2f"|format(qi.rental_price_per_day) }}</td>
                    <td>
                        {% if qi.rental_cost_per_day %}
                            &euro;{{ "%.2f"|format(qi.rental_cost_per_day) }}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </td>
                    <td>
                        &euro;{{ "%.2f"|format(qi.total_price) }}
                        {% if qi.rental_cost_per_day %}
                            <br><small class="text-danger">Kosten: &euro;{{ "%.2f"|format(qi.total_external_cost) }}</small>
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>

    <div class="price-summary">
        <div class="price-row">
            <span>Zwischensumme</span>
            <span>&euro;{{ "%.2f"|format(quote.subtotal) }}</span>
        </div>
        {% if quote.discount_percent > 0 %}
        <div class="price-row">
            <span>Rabattf√§hig</span>
            <span>&euro;{{ "%.2f"|format(quote.discountable_subtotal) }}</span>
        </div>
        <div class="price-row">
            <span>Rabatt{{ ' ‚Äì ' + quote.discount_label if quote.discount_label else '' }} ({{ "%.2f"|format(quote.discount_percent) }}%)</span>
            <span>-&euro;{{ "%.2f"|format(quote.discount_amount) }}</span>
        </div>
        {% endif %}
        <div class="price-row total">
            <span>Gesamt</span>
            <span>&euro;{{ "%.2f"|format(quote.total) }}</span>
        </div>
    </div>
</div>

<!-- Revenue Breakdown -->
{% if quote.status == 'paid' %}
<div class="card">
    <h2>Kosten√ºbersicht</h2>
    {% set ns = namespace(total_ext_cost=0) %}
    {% for qi in quote.quote_items if not qi.is_custom and qi.item and qi.rental_cost_per_day %}
        {% set ns.total_ext_cost = ns.total_ext_cost + qi.total_external_cost %}
    {% endfor %}
    {% if ns.total_ext_cost > 0 %}
    <p>Externe Mietkosten: <strong>&euro;{{ "%.2f"|format(ns.total_ext_cost) }}</strong></p>
    <p>Netto nach ext. Kosten: <strong>&euro;{{ "%.2f"|format(quote.total - ns.total_ext_cost) }}</strong></p>
    {% else %}
    <p>Keine externen Kosten.</p>
    {% endif %}
</div>
{% endif %}

<!-- ERPNext Journal Entries -->
{% if erpnext_enabled and (quote.erpnext_je_receivable or quote.erpnext_je_payment) %}
<div class="card">
    <h2>ERPNext Buchungen</h2>
    {% if quote.erpnext_je_receivable %}
    <p><strong>Forderungsbuchung:</strong> {{ quote.erpnext_je_receivable }}</p>
    {% endif %}
    {% if quote.erpnext_je_payment %}
    <p><strong>Zahlungsbuchung:</strong> {{ quote.erpnext_je_payment }}</p>
    {% endif %}
</div>
{% endif %}

<!-- Actions -->
<div class="card no-print">
    <h2>Aktionen</h2>
    <div class="d-flex gap-10 flex-wrap">
        {% if quote.status == 'finalized' %}
            <!-- Durchf√ºhren Button -->
            {% if quote.performed_at %}
            <button type="button" class="btn btn-info" onclick="showPerformDialog()">Als durchgef√ºhrt markieren</button>
            {% else %}
            <form method="POST" action="{{ url_for('admin.quote_mark_performed', quote_id=quote.id) }}">
                <button type="submit" class="btn btn-info" onclick="return confirm('Als durchgef√ºhrt markieren?{% if erpnext_enabled %} Forderungsbuchung wird in ERPNext erstellt.{% endif %}');">Als durchgef√ºhrt markieren</button>
            </form>
            {% endif %}

            <!-- Bezahlt direkt markieren (√ºberspringt performed) -->
            <button type="button" class="btn btn-success" onclick="showPayDialog()">Als bezahlt markieren</button>

            <form method="POST" action="{{ url_for('admin.quote_unfinalize', quote_id=quote.id) }}">
                <button type="submit" class="btn btn-warning">Finalisierung aufheben</button>
            </form>

        {% elif quote.status == 'performed' %}
            <!-- Bezahlt markieren -->
            <button type="button" class="btn btn-success" onclick="showPayDialog()">Als bezahlt markieren</button>

            <form method="POST" action="{{ url_for('admin.quote_unperform', quote_id=quote.id) }}">
                <button type="submit" class="btn btn-warning" onclick="return confirm('Durchf√ºhrung aufheben?{% if erpnext_enabled %} Forderungsbuchung wird in ERPNext storniert.{% endif %}');">Durchf√ºhrung aufheben</button>
            </form>

        {% elif quote.status == 'paid' %}
            <form method="POST" action="{{ url_for('admin.quote_unpay', quote_id=quote.id) }}">
                <button type="submit" class="btn btn-warning" onclick="return confirm('Zahlung zur√ºcknehmen?{% if erpnext_enabled %} Zahlungsbuchung wird in ERPNext storniert.{% endif %}');">Zahlung aufheben</button>
            </form>
        {% endif %}

        {% if quote.status in ['finalized', 'performed', 'paid'] %}
            <a href="{{ url_for('admin.angebot_pdf', quote_id=quote.id) }}" class="btn btn-primary" target="_blank">Angebot PDF</a>
            <a href="{{ url_for('admin.rechnung_pdf', quote_id=quote.id) }}" class="btn btn-primary" target="_blank">Rechnung PDF</a>
            <a href="{{ url_for('admin.lieferschein_pdf', quote_id=quote.id) }}" class="btn btn-primary" target="_blank">Lieferschein PDF</a>
            <button type="button" class="btn btn-outline" onclick="openKautionDialog()">Lieferschein + Kaution</button>
        {% elif quote.status == 'draft' %}
            <a href="{{ url_for('admin.angebot_pdf', quote_id=quote.id) }}" class="btn btn-primary" target="_blank">Angebot PDF (Entwurf)</a>
            <a href="{{ url_for('admin.rechnung_pdf', quote_id=quote.id) }}" class="btn btn-primary" target="_blank">Rechnung PDF</a>
            <a href="{{ url_for('admin.lieferschein_pdf', quote_id=quote.id) }}" class="btn btn-primary" target="_blank">Lieferschein PDF</a>
            <button type="button" class="btn btn-outline" onclick="openKautionDialog()">Lieferschein + Kaution</button>
        {% endif %}

        {% if quote.status == 'draft' %}
            <a href="{{ url_for('admin.quote_edit', quote_id=quote.id) }}" class="btn btn-outline">Bearbeiten</a>
        {% endif %}

        <form method="POST" action="{{ url_for('admin.quote_delete', quote_id=quote.id) }}" onsubmit="return confirm('Dieses Angebot l√∂schen?{% if erpnext_enabled and (quote.erpnext_je_receivable or quote.erpnext_je_payment) %} Alle ERPNext-Buchungen werden storniert.{% endif %}');">
            <button type="submit" class="btn btn-danger">Angebot l√∂schen</button>
        </form>
    </div>

    {% if quote.status == 'finalized' and quote.performed_at %}
    <div id="perform-dialog" style="display:none;margin-top:12px;">
        <form method="POST" action="{{ url_for('admin.quote_mark_performed', quote_id=quote.id) }}" id="perform-form">
            <p style="margin-bottom:10px;"><strong>‚ö† Vorheriges Durchf√ºhrungsdatum vorhanden</strong></p>
            <p class="text-muted" style="font-size:0.9em;margin-bottom:12px;">Dieses Angebot war zuvor als durchgef√ºhrt markiert ({{ quote.performed_at.strftime('%d.%m.%Y') }}).</p>
            <div class="d-flex gap-10 flex-wrap" style="align-items:center;">
                <button type="submit" name="performed_at" value="{{ quote.performed_at.strftime('%Y-%m-%d') }}" class="btn btn-info">Bisheriges Datum ({{ quote.performed_at.strftime('%d.%m.%Y') }})</button>
                <button type="submit" class="btn btn-outline">Heutiges Datum</button>
                <span style="color:var(--color-text-muted);font-size:0.9em;">oder:</span>
                <input type="date" id="custom-perform-date" style="padding:6px 10px;font-size:0.9em;">
                <button type="button" class="btn btn-outline" onclick="submitCustomPerformDate()">Eigenes Datum</button>
                <button type="button" class="btn btn-sm btn-outline" onclick="document.getElementById('perform-dialog').style.display='none'">Abbrechen</button>
            </div>
        </form>
    </div>
    {% endif %}

    {% if quote.status in ['finalized', 'performed'] %}
    <div id="pay-dialog" style="display:none;margin-top:12px;">
        <form method="POST" action="{{ url_for('admin.quote_mark_paid', quote_id=quote.id) }}" id="pay-form">
            <p style="margin-bottom:10px;"><strong>Zahlungsart w√§hlen</strong></p>
            <div class="d-flex gap-10 flex-wrap" style="align-items:center;margin-bottom:12px;">
                <label style="display:flex;align-items:center;gap:4px;cursor:pointer;">
                    <input type="radio" name="payment_method" value="bank" checked> √úberweisung
                </label>
                <label style="display:flex;align-items:center;gap:4px;cursor:pointer;">
                    <input type="radio" name="payment_method" value="cash"> Bar
                </label>
            </div>
            {% if quote.paid_at %}
            <p class="text-muted" style="font-size:0.9em;margin-bottom:12px;">Dieses Angebot war zuvor als bezahlt markiert ({{ quote.paid_at.strftime('%d.%m.%Y') }}). M√∂chten Sie das bisherige Bezahldatum verwenden oder das heutige Datum?</p>
            <div class="d-flex gap-10 flex-wrap" style="align-items:center;">
                <button type="submit" name="paid_at" value="{{ quote.paid_at.strftime('%Y-%m-%d') }}" class="btn btn-success">Bisheriges Datum ({{ quote.paid_at.strftime('%d.%m.%Y') }})</button>
                <button type="submit" class="btn btn-outline">Heutiges Datum</button>
                <span style="color:var(--color-text-muted);font-size:0.9em;">oder:</span>
                <input type="date" id="custom-pay-date" style="padding:6px 10px;font-size:0.9em;">
                <button type="button" class="btn btn-outline" onclick="submitCustomPayDate()">Eigenes Datum</button>
                <button type="button" class="btn btn-sm btn-outline" onclick="document.getElementById('pay-dialog').style.display='none'">Abbrechen</button>
            </div>
            {% else %}
            <div class="d-flex gap-10 flex-wrap" style="align-items:center;">
                <button type="submit" class="btn btn-success" onclick="return confirm('Als bezahlt markieren?{% if erpnext_enabled %} Zahlungsbuchung wird in ERPNext erstellt.{% endif %}');">Heutiges Datum</button>
                <span style="color:var(--color-text-muted);font-size:0.9em;">oder:</span>
                <input type="date" id="custom-pay-date" style="padding:6px 10px;font-size:0.9em;">
                <button type="button" class="btn btn-outline" onclick="submitCustomPayDate()">Eigenes Datum</button>
                <button type="button" class="btn btn-sm btn-outline" onclick="document.getElementById('pay-dialog').style.display='none'">Abbrechen</button>
            </div>
            {% endif %}
        </form>
    </div>
    {% endif %}
</div>

<!-- Kaution Dialog -->
<div id="kaution-dialog" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:var(--bg-primary, #fff); padding:24px; border-radius:8px; max-width:400px; width:90%; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
        <h3 style="margin:0 0 12px 0;">Lieferschein mit Kaution</h3>
        <div class="form-group">
            <label>Kautionsbetrag (‚Ç¨)</label>
            <input type="number" id="kaution-input" step="0.01" min="0" placeholder="z.B. 500.00" style="width:100%;">
        </div>
        <div class="d-flex gap-10" style="margin-top:16px;">
            <button class="btn btn-primary" onclick="generateLieferscheinWithKaution()">PDF generieren</button>
            <button class="btn btn-outline" onclick="closeKautionDialog()">Abbrechen</button>
        </div>
    </div>
</div>

<script>
function openKautionDialog() {
    document.getElementById('kaution-dialog').style.display = 'flex';
    document.getElementById('kaution-input').focus();
}
function closeKautionDialog() {
    document.getElementById('kaution-dialog').style.display = 'none';
}
function generateLieferscheinWithKaution() {
    var val = document.getElementById('kaution-input').value;
    var url = "{{ url_for('admin.lieferschein_pdf', quote_id=quote.id) }}";
    if (val && parseFloat(val) > 0) {
        url += "?kaution=" + encodeURIComponent(val);
    }
    window.open(url, '_blank');
    closeKautionDialog();
}
document.getElementById('kaution-dialog').addEventListener('click', function(e) {
    if (e.target === this) closeKautionDialog();
});

function showPayDialog() {
    document.getElementById('pay-dialog').style.display = '';
}

function showPerformDialog() {
    document.getElementById('perform-dialog').style.display = '';
}

function submitCustomPayDate() {
    var dateVal = document.getElementById('custom-pay-date').value;
    if (!dateVal) {
        alert('Bitte ein Datum ausw√§hlen.');
        return;
    }
    var form = document.getElementById('pay-form');
    var input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'paid_at';
    input.value = dateVal;
    form.appendChild(input);
    form.submit();
}

function submitCustomPerformDate() {
    var dateVal = document.getElementById('custom-perform-date').value;
    if (!dateVal) {
        alert('Bitte ein Datum ausw√§hlen.');
        return;
    }
    var form = document.getElementById('perform-form');
    var input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'performed_at';
    input.value = dateVal;
    form.appendChild(input);
    form.submit();
}
</script>
{% endblock %}
