{% extends "admin/base.html" %}

{% block title %}Angebot {{ quote.reference_number }} - Verwaltung{% endblock %}

{% block content %}
<div class="actions-bar">
    <h1 class="m-0 flex-1">Angebot: {{ quote.reference_number }}</h1>
    <span class="badge badge-{{ quote.status }} badge-lg">{{ {'draft':'Entwurf','finalized':'Finalisiert','performed':'Durchgef√ºhrt','paid':'Bezahlt'}.get(quote.status, quote.status|capitalize) }}</span>
</div>

<div class="card">
    <div class="form-row">
        <div>
            <p><strong>Kunde:</strong> {{ quote.customer_name }}</p>
            {% if quote.recipient_lines %}
                <p class="text-muted text-pre-line">{{ quote.recipient_lines }}</p>
            {% endif %}
        </div>
        <div>
            <p><strong>Zeitraum:</strong>
                {% if quote.start_date and quote.end_date %}
                    {{ quote.start_date.strftime('%d.%m.%Y') }} ‚Äì {{ quote.end_date.strftime('%d.%m.%Y') }}
                    ({{ quote.calculate_rental_days() }} Tag{{ 'e' if quote.calculate_rental_days() != 1 }})
                {% else %}
                    Nicht gesetzt
                {% endif %}
            </p>
            <p><strong>Referenz:</strong> {{ quote.reference_number }}</p>
            <p><strong>Erstellt:</strong> {{ quote.created_at.strftime('%d.%m.%Y %H:%M') }} von {{ quote.created_by.display_name or quote.created_by.username if quote.created_by else '‚Äî' }}</p>
            {% if quote.status in ['finalized', 'performed', 'paid'] and quote.finalized_at %}
            <p><strong>Finalisiert:</strong> {{ quote.finalized_at.strftime('%d.%m.%Y %H:%M') }}
                {% if quote.status in ['finalized', 'performed', 'paid'] %}
                <button type="button" class="btn btn-sm btn-outline edit-date-btn" id="edit-finalized-date-btn" onclick="document.getElementById('edit-finalized-date').classList.remove('d-none');this.classList.add('d-none');">‚úèÔ∏è Datum √§ndern</button>
                {% endif %}
            </p>
            {% if quote.status in ['finalized', 'performed', 'paid'] %}
            <div id="edit-finalized-date" class="edit-date-wrapper d-none">
                <form method="POST" action="{{ url_for('admin.quote_update_finalized_date', quote_id=quote.id) }}" class="edit-date-form">
                    <input type="date" name="finalized_at" value="{{ quote.finalized_at.strftime('%Y-%m-%d') }}" required class="edit-date-input">
                    <button type="submit" class="btn btn-sm btn-success btn-compact">Speichern</button>
                    <button type="button" class="btn btn-sm btn-outline btn-compact" onclick="document.getElementById('edit-finalized-date').classList.add('d-none');document.getElementById('edit-finalized-date-btn').classList.remove('d-none');">Abbrechen</button>
                </form>
            </div>
            {% endif %}
            {% endif %}
            {% if quote.status in ['performed', 'paid'] and quote.performed_at %}
            <p><strong>Durchgef√ºhrt:</strong> {{ quote.performed_at.strftime('%d.%m.%Y %H:%M') }}
                {% if quote.status in ['performed', 'paid'] %}
                <button type="button" class="btn btn-sm btn-outline edit-date-btn" id="edit-performed-date-btn" onclick="document.getElementById('edit-performed-date').classList.remove('d-none');this.classList.add('d-none');">‚úèÔ∏è Datum √§ndern</button>
                {% endif %}
            </p>
            {% if quote.status in ['performed', 'paid'] %}
            <div id="edit-performed-date" class="edit-date-wrapper d-none">
                <form method="POST" action="{{ url_for('admin.quote_update_performed_date', quote_id=quote.id) }}" class="edit-date-form">
                    <input type="date" name="performed_at" value="{{ quote.performed_at.strftime('%Y-%m-%d') }}" required class="edit-date-input">
                    <button type="submit" class="btn btn-sm btn-success btn-compact">Speichern</button>
                    <button type="button" class="btn btn-sm btn-outline btn-compact" onclick="document.getElementById('edit-performed-date').classList.add('d-none');document.getElementById('edit-performed-date-btn').classList.remove('d-none');">Abbrechen</button>
                </form>
            </div>
            {% endif %}
            {% endif %}
            {% if quote.status == 'paid' and quote.paid_at %}
            <p><strong>Bezahlt:</strong> {{ quote.paid_at.strftime('%d.%m.%Y %H:%M') }}
                {% if quote.status == 'paid' %}
                <button type="button" class="btn btn-sm btn-outline edit-date-btn" id="edit-paid-date-btn" onclick="document.getElementById('edit-paid-date').classList.remove('d-none');this.classList.add('d-none');">‚úèÔ∏è Datum √§ndern</button>
                {% endif %}
            </p>
            {% if quote.status == 'paid' %}
            <div id="edit-paid-date" class="edit-date-wrapper d-none">
                <form method="POST" action="{{ url_for('admin.quote_update_paid_date', quote_id=quote.id) }}" class="edit-date-form">
                    <input type="date" name="paid_at" value="{{ quote.paid_at.strftime('%Y-%m-%d') }}" required class="edit-date-input">
                    <button type="submit" class="btn btn-sm btn-success btn-compact">Speichern</button>
                    <button type="button" class="btn btn-sm btn-outline btn-compact" onclick="document.getElementById('edit-paid-date').classList.add('d-none');document.getElementById('edit-paid-date-btn').classList.remove('d-none');">Abbrechen</button>
                </form>
            </div>
            {% endif %}
            {% endif %}
        </div>
    </div>

    {% if quote.public_notes %}
        <p class="mt-14"><strong>Bemerkungen (auf Rechnung):</strong></p>
        <p class="text-muted text-pre-line">{{ quote.public_notes }}</p>
    {% endif %}
    {% if quote.notes %}
        <p class="mt-14"><strong>Interne Notizen:</strong></p>
        <p class="text-muted text-pre-line">{{ quote.notes }}</p>
    {% endif %}
</div>

<!-- Items -->
<div class="card">
    <h2>Artikel</h2>
    <table>
        <thead>
            <tr><th>Artikel</th><th>Eigent√ºmer</th><th>Menge</th><th>Preis/Tag</th><th>Kosten/Tag</th><th>Summe</th></tr>
        </thead>
        <tbody>
            {% set package_items = quote.quote_items|selectattr('package_id')|list %}
            {% set package_ids = package_items|map(attribute='package_id')|unique|list %}
            {% set shown_ids = [] %}

            {% for qi in quote.quote_items %}
                {% if qi.package_id and qi.package_id not in shown_ids %}
                    {% set pkg_components = package_items|selectattr('package_id', 'equalto', qi.package_id)|list %}
                    {% if shown_ids.append(qi.package_id) %}{% endif %}
                    <tr class="package-header-row">
                        <td colspan="5">
                            <strong>üì¶ {{ qi.package.name }}</strong>
                            <span class="badge badge-package">Paket</span>
                        </td>
                        <td>&euro;{{ "%.2f"|format(pkg_components|sum(attribute='total_price')) }}</td>
                    </tr>
                    {% for pqi in pkg_components %}
                    <tr class="package-component-row">
                        <td class="pl-30">
                            ‚Ü≥ {{ pqi.display_name }}
                            {% if pqi.item and pqi.item.is_external %}
                                <small class="text-external">&#x2197; Extern</small>
                            {% endif %}
                            {% if pqi.discount_exempt and quote.discount_percent > 0 %}
                                <br><small class="text-warning">Kein Rabatt</small>
                            {% endif %}
                        </td>
                        <td>‚Äî</td>
                        <td>{{ pqi.quantity }}</td>
                        <td>&euro;{{ "%.2f"|format(pqi.rental_price_per_day) }}</td>
                        <td>
                            {% if pqi.rental_cost_per_day %}
                                &euro;{{ "%.2f"|format(pqi.rental_cost_per_day) }}
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </td>
                        <td>
                            &euro;{{ "%.2f"|format(pqi.total_price) }}
                            {% if pqi.rental_cost_per_day %}
                                <br><small class="text-danger">Kosten: &euro;{{ "%.2f"|format(pqi.total_external_cost) }}</small>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                {% elif not qi.package_id %}
                <tr>
                    <td>
                        {{ qi.display_name }}
                        {% if qi.item and qi.item.is_external %}
                            <small class="text-external">&#x2197; Extern</small>
                        {% endif %}
                        {% if qi.discount_exempt and quote.discount_percent > 0 %}
                            <br><small class="text-warning">Kein Rabatt</small>
                        {% endif %}
                    </td>
                    <td>‚Äî</td>
                    <td>{{ qi.quantity }}</td>
                    <td>&euro;{{ "%.2f"|format(qi.rental_price_per_day) }}</td>
                    <td>
                        {% if qi.rental_cost_per_day %}
                            &euro;{{ "%.2f"|format(qi.rental_cost_per_day) }}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </td>
                    <td>
                        &euro;{{ "%.2f"|format(qi.total_price) }}
                        {% if qi.rental_cost_per_day %}
                            <br><small class="text-danger">Kosten: &euro;{{ "%.2f"|format(qi.total_external_cost) }}</small>
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>

    <div class="price-summary">
        <div class="price-row">
            <span>Zwischensumme</span>
            <span>&euro;{{ "%.2f"|format(quote.subtotal) }}</span>
        </div>
        {% if quote.discount_percent > 0 %}
        <div class="price-row">
            <span>Rabattf√§hig</span>
            <span>&euro;{{ "%.2f"|format(quote.discountable_subtotal) }}</span>
        </div>
        <div class="price-row">
            <span>Rabatt{{ ' ‚Äì ' + quote.discount_label if quote.discount_label else '' }} ({{ "%.2f"|format(quote.discount_percent) }}%)</span>
            <span>-&euro;{{ "%.2f"|format(quote.discount_amount) }}</span>
        </div>
        {% endif %}
        <div class="price-row total">
            <span>Gesamt</span>
            <span>&euro;{{ "%.2f"|format(quote.total) }}</span>
        </div>
        {% if site_settings and site_settings.tax_mode == 'regular' %}
        {% set mwst_amount = (quote.total - (quote.total / (1 + tax_rate / 100)))|round(2) %}
        <div class="price-row price-row-muted">
            <span>darin enthaltene {{ "%g"|format(tax_rate) }}% MwSt.</span>
            <span>&euro;{{ "%.2f"|format(mwst_amount) }}</span>
        </div>
        {% endif %}
    </div>
</div>

<!-- External Expenses / Ausgaben -->
{% set expense_items = [] %}
{% for qi in quote.quote_items if qi.expense %}
    {% if expense_items.append(qi) %}{% endif %}
{% endfor %}

{% if quote.status in ['finalized', 'performed', 'paid'] and expense_items|length > 0 %}
<div class="card">
    <h2>Externe Ausgaben</h2>
    <p class="text-muted mb-14">Externe Kosten f√ºr dieses Angebot. Markiere jede Ausgabe einzeln als bezahlt ‚Äì nur bezahlte Ausgaben erscheinen in der GuV.</p>

    {% set ns = namespace(total_ext_cost=0, total_paid=0) %}
    {% for qi in expense_items %}
        {% set exp = qi.expense %}
        {% set ns.total_ext_cost = ns.total_ext_cost + exp.amount %}
        {% if exp.paid %}{% set ns.total_paid = ns.total_paid + exp.amount %}{% endif %}
    <div class="expense-card">
        <div class="expense-card-header">
            <div>
                <strong>{{ qi.display_name }}</strong>
                <span class="text-muted expense-card-meta">({{ qi.quantity }}√ó &euro;{{ "%.2f"|format(qi.rental_cost_per_day) }}/Tag √ó {{ qi.quote.calculate_rental_days() }} Tage)</span>
            </div>
            <div class="expense-card-amount">
                <strong>&euro;{{ "%.2f"|format(exp.amount) }}</strong>
                {% if exp.paid %}
                    <span class="badge badge-paid">Bezahlt{{ ' am ' + exp.paid_at.strftime('%d.%m.%Y') if exp.paid_at }}</span>
                {% else %}
                    <span class="badge badge-draft">Unbezahlt</span>
                {% endif %}
            </div>
        </div>

        {% if exp.notes %}
        <p class="text-muted expense-card-notes">{{ exp.notes }}</p>
        {% endif %}

        <!-- Documents -->
        {% if exp.documents %}
        <div class="expense-docs-section">
            <small class="text-muted"><strong>Dokumente:</strong></small>
            <div id="expense-docs-{{ exp.id }}" class="expense-docs-tags">
                {% for doc in exp.documents %}
                <div class="expense-doc-tag" id="expense-doc-{{ doc.id }}">
                    <a href="{{ url_for('admin.expense_download_document', doc_id=doc.id) }}" title="Herunterladen">üìÑ {{ doc.original_name }}</a>
                    <button type="button" onclick="deleteExpenseDoc({{ doc.id }})" class="expense-doc-delete-btn" title="L√∂schen">&times;</button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Actions -->
        <div class="expense-actions">
            {% if not exp.paid %}
            <button type="button" class="btn btn-sm btn-success" onclick="showExpensePayDialog({{ exp.id }})">Als bezahlt markieren</button>
            {% else %}
            <form method="POST" action="{{ url_for('admin.expense_mark_unpaid', expense_id=exp.id) }}" class="d-inline">
                <button type="submit" class="btn btn-sm btn-warning">Zahlung aufheben</button>
            </form>
            {% endif %}

            <!-- File upload -->
            <label class="btn btn-sm btn-outline upload-label">
                üìé Dokument hochladen
                <input type="file" class="upload-input-hidden" onchange="uploadExpenseDoc({{ exp.id }}, this)">
            </label>
        </div>

        <!-- Pay dialog (hidden) -->
        {% if not exp.paid %}
        <div id="pay-expense-{{ exp.id }}" class="expense-pay-dialog d-none">
            <form method="POST" action="{{ url_for('admin.expense_mark_paid', expense_id=exp.id) }}" class="expense-pay-form">
                <label class="expense-pay-label">Bezahldatum:</label>
                <input type="date" name="paid_at" value="{{ exp.paid_at.strftime('%Y-%m-%d') if exp.paid_at else today }}" class="dialog-input-sm">
                <input type="text" name="notes" placeholder="Notiz (optional)" class="dialog-input-notes">
                {% if accounting_configured %}
                <div class="form-group mt-6 mb-6" style="width: 100%;">
                    <label class="text-sm">Konto</label>
                    <select name="accounting_account_id" id="acct-expense-account-{{ exp.id }}" class="w-full">
                        <option value="">Standard (aus Einstellungen)</option>
                    </select>
                </div>
                {% endif %}
                <button type="submit" class="btn btn-sm btn-success">Best√§tigen</button>
                <button type="button" class="btn btn-sm btn-outline" onclick="this.closest('[id^=pay-expense]').classList.add('d-none')">Abbrechen</button>
            </form>
        </div>
        {% endif %}
    </div>
    {% endfor %}

    <div class="price-summary mt-10">
        <div class="price-row">
            <span>Externe Kosten gesamt</span>
            <span>&euro;{{ "%.2f"|format(ns.total_ext_cost) }}</span>
        </div>
        <div class="price-row">
            <span>Davon bezahlt</span>
            <span>&euro;{{ "%.2f"|format(ns.total_paid) }}</span>
        </div>
        <div class="price-row">
            <span>Noch offen</span>
            <span>&euro;{{ "%.2f"|format(ns.total_ext_cost - ns.total_paid) }}</span>
        </div>
        <div class="price-row total">
            <span>Netto nach ext. Kosten</span>
            <span>&euro;{{ "%.2f"|format(quote.total - ns.total_ext_cost) }}</span>
        </div>
    </div>
</div>

<script>
function uploadExpenseDoc(expenseId, input) {
    if (!input.files || !input.files[0]) return;
    var formData = new FormData();
    formData.append('document', input.files[0]);
    fetch('/admin/expense/' + expenseId + '/upload-document', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) { alert(data.error); return; }
        var container = document.getElementById('expense-docs-' + expenseId);
        if (!container) {
            // Create container if it doesn't exist
            location.reload();
            return;
        }
        var div = document.createElement('div');
        div.className = 'expense-doc-tag';
        div.id = 'expense-doc-' + data.id;
        div.innerHTML = '<a href="' + data.download_url + '" title="Herunterladen">üìÑ ' + data.original_name + '</a>' +
            '<button type="button" onclick="deleteExpenseDoc(' + data.id + ')" class="expense-doc-delete-btn" title="L√∂schen">&times;</button>';
        container.appendChild(div);
        input.value = '';
    })
    .catch(err => { alert('Upload fehlgeschlagen: ' + err); input.value = ''; });
}

function deleteExpenseDoc(docId) {
    if (!confirm('Dokument l√∂schen?')) return;
    fetch('/admin/expense/document/' + docId + '/delete', { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            var el = document.getElementById('expense-doc-' + docId);
            if (el) el.remove();
        } else {
            alert(data.error || 'Fehler beim L√∂schen');
        }
    })
    .catch(err => alert('Fehler: ' + err));
}
</script>
{% endif %}

<!-- Revenue Breakdown -->
{% if quote.status == 'paid' %}
<div class="card">
    <h2>Kosten√ºbersicht</h2>
    {% set ns2 = namespace(total_ext_cost=0) %}
    {% for qi in quote.quote_items if not qi.is_custom and qi.item and qi.rental_cost_per_day %}
        {% set ns2.total_ext_cost = ns2.total_ext_cost + qi.total_external_cost %}
    {% endfor %}
    {% if ns2.total_ext_cost > 0 %}
    <p>Externe Mietkosten: <strong>&euro;{{ "%.2f"|format(ns2.total_ext_cost) }}</strong></p>
    <p>Netto nach ext. Kosten: <strong>&euro;{{ "%.2f"|format(quote.total - ns2.total_ext_cost) }}</strong></p>
    {% else %}
    <p>Keine externen Kosten.</p>
    {% endif %}
</div>
{% endif %}

<!-- Actions -->
<div class="card no-print">
    <h2>Aktionen</h2>
    <div class="d-flex gap-10 flex-wrap">
        {% if quote.status == 'finalized' %}
            <!-- Durchf√ºhren Button -->
            {% if quote.performed_at %}
            <button type="button" class="btn btn-info" onclick="showPerformDialog()">Als durchgef√ºhrt markieren</button>
            {% else %}
            <form method="POST" action="{{ url_for('admin.quote_mark_performed', quote_id=quote.id) }}">
                <button type="submit" class="btn btn-info" onclick="return confirm('Als durchgef√ºhrt markieren?');">Als durchgef√ºhrt markieren</button>
            </form>
            {% endif %}

            <!-- Bezahlt direkt markieren (√ºberspringt performed) -->
            <button type="button" class="btn btn-success" onclick="showPayDialog()">Als bezahlt markieren</button>

            <form method="POST" action="{{ url_for('admin.quote_unfinalize', quote_id=quote.id) }}">
                <button type="submit" class="btn btn-warning">Finalisierung aufheben</button>
            </form>

        {% elif quote.status == 'performed' %}
            <!-- Bezahlt markieren -->
            <button type="button" class="btn btn-success" onclick="showPayDialog()">Als bezahlt markieren</button>

            <form method="POST" action="{{ url_for('admin.quote_unperform', quote_id=quote.id) }}">
                <button type="submit" class="btn btn-warning" onclick="return confirm('Durchf√ºhrung aufheben?');">Durchf√ºhrung aufheben</button>
            </form>

        {% elif quote.status == 'paid' %}
            <form method="POST" action="{{ url_for('admin.quote_unpay', quote_id=quote.id) }}">
                <button type="submit" class="btn btn-warning" onclick="return confirm('Zahlung zur√ºcknehmen?');">Zahlung aufheben</button>
            </form>
        {% endif %}

        {% if quote.status in ['finalized', 'performed', 'paid'] %}
            <a href="{{ url_for('admin.angebot_pdf', quote_id=quote.id) }}" class="btn btn-primary" target="_blank">Angebot PDF</a>
            <a href="{{ url_for('admin.rechnung_pdf', quote_id=quote.id) }}" class="btn btn-primary" target="_blank">Rechnung PDF</a>
            <a href="{{ url_for('admin.lieferschein_pdf', quote_id=quote.id) }}" class="btn btn-primary" target="_blank">Lieferschein PDF</a>
            <button type="button" class="btn btn-outline" onclick="openKautionDialog()">Lieferschein + Kaution</button>
        {% elif quote.status == 'draft' %}
            <a href="{{ url_for('admin.angebot_pdf', quote_id=quote.id) }}" class="btn btn-primary" target="_blank">Angebot PDF (Entwurf)</a>
            <a href="{{ url_for('admin.rechnung_pdf', quote_id=quote.id) }}" class="btn btn-primary" target="_blank">Rechnung PDF</a>
            <a href="{{ url_for('admin.lieferschein_pdf', quote_id=quote.id) }}" class="btn btn-primary" target="_blank">Lieferschein PDF</a>
            <button type="button" class="btn btn-outline" onclick="openKautionDialog()">Lieferschein + Kaution</button>
        {% endif %}

        {% if quote.status == 'draft' %}
            <a href="{{ url_for('admin.quote_edit', quote_id=quote.id) }}" class="btn btn-outline">Bearbeiten</a>
        {% endif %}

        {% if quote.status == 'draft' %}
        <form method="POST" action="{{ url_for('admin.quote_delete', quote_id=quote.id) }}" onsubmit="return confirm('Dieses Angebot l√∂schen?');">
            <button type="submit" class="btn btn-danger">Angebot l√∂schen</button>
        </form>
        {% endif %}
    </div>

    {% if quote.status == 'finalized' and quote.performed_at %}
    <div id="perform-dialog" class="action-dialog d-none">
        <form method="POST" action="{{ url_for('admin.quote_mark_performed', quote_id=quote.id) }}" id="perform-form">
            <p class="dialog-heading"><strong>‚ö† Vorheriges Durchf√ºhrungsdatum vorhanden</strong></p>
            <p class="text-muted dialog-text">Dieses Angebot war zuvor als durchgef√ºhrt markiert ({{ quote.performed_at.strftime('%d.%m.%Y') }}).</p>
            <div class="d-flex gap-10 flex-wrap align-center">
                <button type="submit" name="performed_at" value="{{ quote.performed_at.strftime('%Y-%m-%d') }}" class="btn btn-info">Bisheriges Datum ({{ quote.performed_at.strftime('%d.%m.%Y') }})</button>
                <button type="submit" class="btn btn-outline">Heutiges Datum</button>
                <span class="dialog-hint">oder:</span>
                <input type="date" id="custom-perform-date" class="dialog-date-input">
                <button type="button" class="btn btn-outline" onclick="submitCustomPerformDate()">Eigenes Datum</button>
                <button type="button" class="btn btn-sm btn-outline" onclick="document.getElementById('perform-dialog').classList.add('d-none')">Abbrechen</button>
            </div>
        </form>
    </div>
    {% endif %}

    {% if quote.status in ['finalized', 'performed'] %}
    <div id="pay-dialog" class="action-dialog d-none">
        <form method="POST" action="{{ url_for('admin.quote_mark_paid', quote_id=quote.id) }}" id="pay-form">
            <p class="dialog-heading"><strong>Als bezahlt markieren</strong></p>
            {% if accounting_configured %}
            <div class="form-group mt-10 mb-10">
                <label class="text-sm"><strong>Buchhaltung ‚Äì Steuerbehandlung</strong></label>
                <select name="accounting_tax_treatment" id="acct-tax-treatment" class="w-full">
                    <option value="">Standard (aus Einstellungen)</option>
                </select>
                <small class="help-text">Wird f√ºr die Buchung in der Buchhaltungs-API verwendet.</small>
            </div>
            <div class="form-group mb-10">
                <label class="text-sm"><strong>Buchhaltung ‚Äì Konto</strong></label>
                <select name="accounting_account_id" id="acct-account" class="w-full">
                    <option value="">Standard (aus Einstellungen)</option>
                </select>
                <small class="help-text">Konto, auf das die Zahlung gebucht wird.</small>
            </div>
            {% endif %}
            {% if quote.paid_at %}
            <p class="text-muted dialog-text">Dieses Angebot war zuvor als bezahlt markiert ({{ quote.paid_at.strftime('%d.%m.%Y') }}). M√∂chten Sie das bisherige Bezahldatum verwenden oder das heutige Datum?</p>
            <div class="d-flex gap-10 flex-wrap align-center">
                <button type="submit" name="paid_at" value="{{ quote.paid_at.strftime('%Y-%m-%d') }}" class="btn btn-success">Bisheriges Datum ({{ quote.paid_at.strftime('%d.%m.%Y') }})</button>
                <button type="submit" class="btn btn-outline">Heutiges Datum</button>
                <span class="dialog-hint">oder:</span>
                <input type="date" id="custom-pay-date" class="dialog-date-input">
                <button type="button" class="btn btn-outline" onclick="submitCustomPayDate()">Eigenes Datum</button>
                <button type="button" class="btn btn-sm btn-outline" onclick="document.getElementById('pay-dialog').classList.add('d-none')">Abbrechen</button>
            </div>
            {% else %}
            <div class="d-flex gap-10 flex-wrap align-center">
                <button type="submit" class="btn btn-success" onclick="return confirm('Als bezahlt markieren?');">Heutiges Datum</button>
                <span class="dialog-hint">oder:</span>
                <input type="date" id="custom-pay-date" class="dialog-date-input">
                <button type="button" class="btn btn-outline" onclick="submitCustomPayDate()">Eigenes Datum</button>
                <button type="button" class="btn btn-sm btn-outline" onclick="document.getElementById('pay-dialog').classList.add('d-none')">Abbrechen</button>
            </div>
            {% endif %}
        </form>
    </div>
    {% endif %}
</div>

<!-- Kaution Dialog -->
<div id="kaution-dialog" class="modal-overlay d-none">
    <div class="modal-dialog">
        <h3 class="modal-title">Lieferschein mit Kaution</h3>
        <div class="form-group">
            <label>Kautionsbetrag (‚Ç¨)</label>
            <input type="number" id="kaution-input" step="0.01" min="0" placeholder="z.B. 500.00" class="w-full">
        </div>
        <div class="d-flex gap-10 mt-16">
            <button class="btn btn-primary" onclick="generateLieferscheinWithKaution()">PDF generieren</button>
            <button class="btn btn-outline" onclick="closeKautionDialog()">Abbrechen</button>
        </div>
    </div>
</div>

<script>
function openKautionDialog() {
    document.getElementById('kaution-dialog').classList.remove('d-none');
    document.getElementById('kaution-input').focus();
}
function closeKautionDialog() {
    document.getElementById('kaution-dialog').classList.add('d-none');
}
function generateLieferscheinWithKaution() {
    var val = document.getElementById('kaution-input').value;
    var url = "{{ url_for('admin.lieferschein_pdf', quote_id=quote.id) }}";
    if (val && parseFloat(val) > 0) {
        url += "?kaution=" + encodeURIComponent(val);
    }
    window.open(url, '_blank');
    closeKautionDialog();
}
document.getElementById('kaution-dialog').addEventListener('click', function(e) {
    if (e.target === this) closeKautionDialog();
});

function showPayDialog() {
    document.getElementById('pay-dialog').classList.remove('d-none');
    {% if accounting_configured %}
    loadTaxTreatments();
    loadAccounts('acct-account');
    {% endif %}
}

{% if accounting_configured %}
var _taxTreatmentsLoaded = false;
function loadTaxTreatments() {
    if (_taxTreatmentsLoaded) return;
    _taxTreatmentsLoaded = true;
    var saved = '{{ quote.accounting_tax_treatment or "" }}';
    fetch('{{ url_for("admin.accounting_tax_treatments") }}')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var sel = document.getElementById('acct-tax-treatment');
            if (!data.tax_treatments) return;
            data.tax_treatments.forEach(function(t) {
                var opt = document.createElement('option');
                opt.value = t.value;
                opt.textContent = t.label;
                if (saved && t.value === saved) opt.selected = true;
                sel.appendChild(opt);
            });
        })
        .catch(function(err) { console.error('Tax treatments load error:', err); });
}

var _accountsCache = null;
function loadAccounts(selectId) {
    var sel = document.getElementById(selectId);
    if (!sel) return;
    if (sel.options.length > 1) return; // already loaded

    function populate(accounts) {
        accounts.forEach(function(a) {
            var opt = document.createElement('option');
            opt.value = a.id;
            opt.textContent = a.name + (a.description ? ' ‚Äì ' + a.description : '');
            sel.appendChild(opt);
        });
    }

    if (_accountsCache) {
        populate(_accountsCache);
        return;
    }

    fetch('{{ url_for("admin.accounting_accounts") }}')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (!data.accounts) return;
            _accountsCache = data.accounts;
            populate(data.accounts);
        })
        .catch(function(err) { console.error('Accounts load error:', err); });
}
{% endif %}

function showPerformDialog() {
    document.getElementById('perform-dialog').classList.remove('d-none');
}

function showExpensePayDialog(expenseId) {
    document.getElementById('pay-expense-' + expenseId).classList.remove('d-none');
    {% if accounting_configured %}
    loadAccounts('acct-expense-account-' + expenseId);
    {% endif %}
}

function submitCustomPayDate() {
    var dateVal = document.getElementById('custom-pay-date').value;
    if (!dateVal) {
        alert('Bitte ein Datum ausw√§hlen.');
        return;
    }
    var form = document.getElementById('pay-form');
    var input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'paid_at';
    input.value = dateVal;
    form.appendChild(input);
    form.submit();
}

function submitCustomPerformDate() {
    var dateVal = document.getElementById('custom-perform-date').value;
    if (!dateVal) {
        alert('Bitte ein Datum ausw√§hlen.');
        return;
    }
    var form = document.getElementById('perform-form');
    var input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'performed_at';
    input.value = dateVal;
    form.appendChild(input);
    form.submit();
}
</script>
{% endblock %}
