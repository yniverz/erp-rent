{% extends "admin/base.html" %}

{% block title %}Zeitplan - Verwaltung{% endblock %}

{% set month_names = {1:'Januar',2:'Februar',3:'März',4:'April',5:'Mai',6:'Juni',7:'Juli',8:'August',9:'September',10:'Oktober',11:'November',12:'Dezember'} %}

{% block content %}
<h1>Mietplan</h1>

<div class="view-toggle">
    <button class="btn btn-outline active-view" onclick="switchView('calendar')" id="btn-calendar">Kalender</button>
    <button class="btn btn-outline" onclick="switchView('table')" id="btn-table">Tabelle</button>
</div>

<!-- ========== CALENDAR VIEW ========== -->
<div id="calendar-view" class="show">
    <div class="cal-header">
        <a href="{{ url_for('admin.schedule', year=prev_year, month=prev_month) }}" class="btn btn-outline btn-sm">&laquo; Zurück</a>
        <h2>{{ month_names[cal_month] }} {{ cal_year }}</h2>
        <div class="cal-nav">
            {% if cal_year != today.year or cal_month != today.month %}
            <a href="{{ url_for('admin.schedule') }}" class="btn btn-outline btn-sm">Heute</a>
            {% endif %}
            <a href="{{ url_for('admin.schedule', year=next_year, month=next_month) }}" class="btn btn-outline btn-sm">Weiter &raquo;</a>
        </div>
    </div>

    <div class="cal-legend">
        <div class="cal-legend-item"><span class="cal-legend-dot paid"></span> Bezahlt</div>
        <div class="cal-legend-item"><span class="cal-legend-dot finalized"></span> Finalisiert</div>
        <div class="cal-legend-item"><span class="cal-legend-dot draft"></span> Entwurf</div>
        <div class="cal-legend-item"><span class="cal-legend-dot inquiry"></span> Anfrage</div>
    </div>

    <table class="cal-grid">
        <thead>
            <tr>
                <th>Mo</th><th>Di</th><th>Mi</th><th>Do</th><th>Fr</th><th>Sa</th><th>So</th>
            </tr>
        </thead>
        <tbody>
            {% for week in weeks %}
            <tr>
                {% for cell in week %}
                {% if cell is none %}
                <td class="empty"></td>
                {% else %}
                <td class="{{ 'today' if cell.date == today else '' }}">
                    <div class="cal-day-num {{ 'today-num' if cell.date == today else '' }}">{{ cell.day }}</div>
                    {% for ev in cell.events[:4] %}
                    {% if ev.type == 'quote' %}
                    <a class="cal-event status-{{ ev.status }}"
                       href="{{ url_for('admin.quote_view', quote_id=ev.id) if ev.status != 'draft' else url_for('admin.quote_edit', quote_id=ev.id) }}"
                       title="{{ ev.customer }} ({{ ev.status|capitalize }})">
                        {{ ev.label }}
                    </a>
                    {% else %}
                    <a class="cal-event status-inquiry"
                       href="{{ url_for('admin.inquiry_view', inquiry_id=ev.id) }}"
                       title="{{ ev.customer }} (Anfrage)">
                        {{ ev.label }}
                    </a>
                    {% endif %}
                    {% endfor %}
                    {% if cell.events|length > 4 %}
                    <span class="cal-more">+{{ cell.events|length - 4 }} weitere</span>
                    {% endif %}
                </td>
                {% endif %}
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- ========== TABLE VIEW ========== -->
<div id="table-view">
    <table class="schedule-table">
        <thead>
            <tr>
                <th>Ref.-Nr.</th>
                <th>Kunde</th>
                <th>Start</th>
                <th>Ende</th>
                <th>Tage</th>
                <th>Status</th>
                <th>Artikel</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for quote in quotes %}
            <tr>
                <td><strong>{{ quote.reference_number or '—' }}</strong></td>
                <td>{{ quote.customer_name }}</td>
                <td>{{ quote.start_date.strftime('%d.%m.%Y') if quote.start_date else '—' }}</td>
                <td>{{ quote.end_date.strftime('%d.%m.%Y') if quote.end_date else '—' }}</td>
                <td>{{ quote.calculate_rental_days() }}</td>
                <td><span class="badge badge-{{ quote.status }}">{{ quote.status|capitalize }}</span></td>
                <td>
                    {% for qi in quote.quote_items[:3] %}
                        {{ qi.display_name }}{% if not loop.last %}, {% endif %}
                    {% endfor %}
                    {% if quote.quote_items|length > 3 %}
                        + {{ quote.quote_items|length - 3 }} weitere
                    {% endif %}
                </td>
                <td>
                    {% if quote.status == 'draft' %}
                        <a href="{{ url_for('admin.quote_edit', quote_id=quote.id) }}" class="btn btn-sm btn-outline">Bearbeiten</a>
                    {% else %}
                        <a href="{{ url_for('admin.quote_view', quote_id=quote.id) }}" class="btn btn-sm btn-outline">Ansehen</a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            {% if not quotes %}
            <tr><td colspan="8" class="empty-state">Keine geplanten Vermietungen.</td></tr>
            {% endif %}
        </tbody>
    </table>
</div>

<script>
function switchView(view) {
    document.getElementById('calendar-view').classList.toggle('show', view === 'calendar');
    document.getElementById('table-view').classList.toggle('show', view === 'table');
    document.getElementById('btn-calendar').classList.toggle('active-view', view === 'calendar');
    document.getElementById('btn-table').classList.toggle('active-view', view === 'table');
    localStorage.setItem('scheduleView', view);
}
// Restore last view
const saved = localStorage.getItem('scheduleView');
if (saved) switchView(saved);
</script>
{% endblock %}
