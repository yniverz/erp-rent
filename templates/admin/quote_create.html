{% extends "admin/base.html" %}

{% block title %}Angebot erstellen - Verwaltung{% endblock %}

{% block content %}
<h1>Neues Angebot erstellen</h1>

<div class="card">
    <form method="POST">
        <input type="hidden" name="api_customer_id" id="api_customer_id" value="">
        <div class="form-group autocomplete-wrapper">
            <label>Kundenname *</label>
            <input type="text" name="customer_name" id="customer_name" required autocomplete="off">
            <div class="autocomplete-list" id="customer-suggestions"></div>
        </div>
        <div class="form-group">
            <label>Empfängeradresse</label>
            <textarea name="recipient_lines" id="recipient_lines" rows="3"></textarea>
        </div>
        {% if accounting_configured %}
        <div id="api-customer-info" class="d-none mb-16">
            <small class="text-muted">API-Kunde: <span id="api-customer-label">—</span></small>
            <button type="button" class="btn btn-sm btn-outline" onclick="clearApiCustomer()">Zuordnung aufheben</button>
        </div>
        <div class="mb-16">
            <button type="button" class="btn btn-outline btn-sm" id="create-api-customer-btn">Neuen API-Kunden anlegen</button>
            <span class="customer-save-feedback" id="save-feedback"></span>
        </div>
        <!-- Inline Create API Customer Dialog -->
        <div id="create-api-customer-dialog" class="action-dialog d-none mb-16">
            <h3 class="mt-0">Neuen Kunden anlegen (API)</h3>
            <div class="form-row">
                <div class="form-group"><label>Name *</label><input type="text" id="new-api-cust-name"></div>
                <div class="form-group"><label>Firma</label><input type="text" id="new-api-cust-company"></div>
            </div>
            <div class="form-group"><label>Adresse</label><textarea id="new-api-cust-address" rows="2"></textarea></div>
            <div class="form-row">
                <div class="form-group"><label>E-Mail</label><input type="email" id="new-api-cust-email"></div>
                <div class="form-group"><label>Telefon</label><input type="text" id="new-api-cust-phone"></div>
            </div>
            <div class="d-flex gap-10">
                <button type="button" class="btn btn-success btn-sm" onclick="submitCreateApiCustomer()">Anlegen</button>
                <button type="button" class="btn btn-outline btn-sm" onclick="document.getElementById('create-api-customer-dialog').classList.add('d-none')">Abbrechen</button>
            </div>
        </div>
        {% else %}
        <div class="mb-16">
            <button type="button" class="btn btn-outline btn-sm" id="save-customer-btn">Kunde speichern</button>
            <span class="customer-save-feedback" id="save-feedback"></span>
        </div>
        {% endif %}
        <div class="form-row">
            <div class="form-group">
                <label>Startdatum</label>
                <input type="date" name="start_date">
            </div>
            <div class="form-group">
                <label>Enddatum</label>
                <input type="date" name="end_date">
            </div>
        </div>
        <div class="d-flex gap-10">
            <button type="submit" class="btn btn-success">Angebot erstellen</button>
            <a href="{{ url_for('admin.quote_list') }}" class="btn btn-outline">Abbrechen</a>
        </div>
    </form>
</div>

<script>
(function() {
    const nameInput = document.getElementById('customer_name');
    const addrInput = document.getElementById('recipient_lines');
    const sugBox = document.getElementById('customer-suggestions');
    const feedback = document.getElementById('save-feedback');
    const apiCustIdInput = document.getElementById('api_customer_id');
    let debounce = null;
    let activeIdx = -1;
    let suggestions = [];
    const useApi = {{ 'true' if accounting_configured else 'false' }};

    nameInput.addEventListener('input', function() {
        clearTimeout(debounce);
        const q = this.value.trim();
        if (q.length < 1) { hideSuggestions(); return; }
        debounce = setTimeout(() => fetchSuggestions(q), 200);
    });

    nameInput.addEventListener('keydown', function(e) {
        const items = sugBox.querySelectorAll('div');
        if (!items.length) return;
        if (e.key === 'ArrowDown') { e.preventDefault(); activeIdx = Math.min(activeIdx + 1, items.length - 1); highlight(items); }
        else if (e.key === 'ArrowUp') { e.preventDefault(); activeIdx = Math.max(activeIdx - 1, 0); highlight(items); }
        else if (e.key === 'Enter' && activeIdx >= 0) { e.preventDefault(); selectSuggestion(activeIdx); }
        else if (e.key === 'Escape') { hideSuggestions(); }
    });

    document.addEventListener('click', function(e) {
        if (!sugBox.contains(e.target) && e.target !== nameInput) hideSuggestions();
    });

    function fetchSuggestions(q) {
        const url = useApi
            ? '{{ url_for("admin.api_customer_search") }}?q=' + encodeURIComponent(q)
            : '{{ url_for("admin.customer_search") }}?q=' + encodeURIComponent(q);
        fetch(url)
            .then(r => r.json())
            .then(data => {
                suggestions = data;
                renderSuggestions(data);
            });
    }

    function renderSuggestions(data) {
        sugBox.innerHTML = '';
        activeIdx = -1;
        if (!data.length) { hideSuggestions(); return; }
        data.forEach((c, i) => {
            const d = document.createElement('div');
            if (useApi) {
                d.textContent = c.name + (c.company ? ' (' + c.company + ')' : '');
            } else {
                d.textContent = c.name;
            }
            d.addEventListener('mousedown', (e) => { e.preventDefault(); selectSuggestion(i); });
            sugBox.appendChild(d);
        });
        sugBox.style.display = 'block';
    }

    function selectSuggestion(idx) {
        const c = suggestions[idx];
        nameInput.value = c.name;
        if (useApi) {
            addrInput.value = c.address || '';
            apiCustIdInput.value = c.id;
            showApiCustomerInfo(c);
        } else {
            addrInput.value = c.recipient_lines || '';
        }
        hideSuggestions();
    }

    function highlight(items) {
        items.forEach((el, i) => el.classList.toggle('active', i === activeIdx));
    }

    function hideSuggestions() { sugBox.style.display = ''; activeIdx = -1; }

    function setFeedback(msg, isError) {
        feedback.textContent = msg;
        feedback.classList.toggle('text-danger', isError);
        feedback.classList.toggle('text-success', !isError);
    }

    {% if accounting_configured %}
    // API customer mode
    function showApiCustomerInfo(c) {
        const info = document.getElementById('api-customer-info');
        const label = document.getElementById('api-customer-label');
        label.textContent = c.name + (c.company ? ' (' + c.company + ')' : '') + ' [#' + c.id + ']';
        info.classList.remove('d-none');
    }

    window.clearApiCustomer = function() {
        apiCustIdInput.value = '';
        document.getElementById('api-customer-info').classList.add('d-none');
    };

    const createBtn = document.getElementById('create-api-customer-btn');
    if (createBtn) {
        createBtn.addEventListener('click', function() {
            // Pre-fill name from the name input
            document.getElementById('new-api-cust-name').value = nameInput.value.trim();
            document.getElementById('new-api-cust-address').value = addrInput.value;
            document.getElementById('create-api-customer-dialog').classList.remove('d-none');
        });
    }

    window.submitCreateApiCustomer = function() {
        const name = document.getElementById('new-api-cust-name').value.trim();
        if (!name) { setFeedback('Name ist erforderlich.', true); return; }
        fetch('{{ url_for("admin.api_customer_create") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: name,
                company: document.getElementById('new-api-cust-company').value.trim(),
                address: document.getElementById('new-api-cust-address').value.trim(),
                email: document.getElementById('new-api-cust-email').value.trim(),
                phone: document.getElementById('new-api-cust-phone').value.trim()
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.error) { setFeedback(data.error, true); return; }
            nameInput.value = data.name;
            addrInput.value = data.address || '';
            apiCustIdInput.value = data.id;
            showApiCustomerInfo(data);
            document.getElementById('create-api-customer-dialog').classList.add('d-none');
            setFeedback('API-Kunde angelegt!', false);
            setTimeout(() => feedback.textContent = '', 3000);
        })
        .catch(() => { setFeedback('Fehler beim Anlegen.', true); });
    };
    {% else %}
    // Local customer mode
    const saveBtn = document.getElementById('save-customer-btn');
    if (saveBtn) {
        saveBtn.addEventListener('click', function() {
            const name = nameInput.value.trim();
            if (!name) { setFeedback('Bitte Kundenname eingeben.', true); return; }
            fetch('{{ url_for("admin.customer_save") }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: name, recipient_lines: addrInput.value})
            })
            .then(r => r.json())
            .then(data => {
                if (data.error) { setFeedback(data.error, true); }
                else {
                    setFeedback(data.action === 'updated' ? 'Kunde aktualisiert!' : 'Kunde gespeichert!', false);
                    setTimeout(() => feedback.textContent = '', 3000);
                }
            })
            .catch(() => { setFeedback('Fehler beim Speichern.', true); });
        });
    }
    {% endif %}
})();
</script>
{% endblock %}
