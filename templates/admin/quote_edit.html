{% extends "admin/base.html" %}

{% block title %}Angebot {{ quote.reference_number }} bearbeiten - Verwaltung{% endblock %}

{% block content %}
<div class="actions-bar">
    <h1 class="m-0 flex-1">Angebot bearbeiten: {{ quote.reference_number or 'Entwurf' }}</h1>
    <span class="badge badge-{{ quote.status }} badge-lg">{{ {'draft':'Entwurf','finalized':'Finalisiert','performed':'DurchgefÃ¼hrt','paid':'Bezahlt'}.get(quote.status, quote.status|capitalize) }}</span>
</div>

{% if quote.inquiry %}
<div class="alert alert-info">
    Dieses Angebot wurde aus <a href="{{ url_for('admin.inquiry_view', inquiry_id=quote.inquiry_id) }}">Anfrage #{{ quote.inquiry_id }}</a> erstellt.
</div>
{% endif %}

<!-- Quote Details -->
<div class="card quote-section">
    <h2>Angebotsdetails</h2>
    <form method="POST">
        <input type="hidden" name="action" value="update_quote">
        <div class="form-row">
            <div class="form-group autocomplete-wrapper">
                <label>Kundenname</label>
                <input type="text" name="customer_name" id="customer_name" value="{{ quote.customer_name }}" required autocomplete="off">
                <div class="autocomplete-list" id="customer-suggestions"></div>
            </div>
            <div class="form-group">
                <label>Referenz</label>
                <input type="text" value="{{ quote.reference_number }}" disabled>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Startdatum</label>
                <input type="date" name="start_date" value="{{ quote.start_date.strftime('%Y-%m-%d') if quote.start_date else '' }}">
            </div>
            <div class="form-group">
                <label>Enddatum</label>
                <input type="date" name="end_date" value="{{ quote.end_date.strftime('%Y-%m-%d') if quote.end_date else '' }}">
            </div>
        </div>
        <div class="form-group">
            <label>EmpfÃ¤ngeradresse</label>
            <textarea name="recipient_lines" id="recipient_lines" rows="3">{{ quote.recipient_lines or '' }}</textarea>
        </div>
        <div class="mb-16">
            <button type="button" class="btn btn-outline btn-sm" id="save-customer-btn">Kunde speichern</button>
            <button type="button" class="btn btn-danger btn-sm d-none" id="delete-customer-btn">Kunde lÃ¶schen</button>
            <span class="customer-save-feedback" id="save-feedback"></span>
        </div>
        <div class="form-group">
            <label>Interne Notizen</label>
            <textarea name="notes" rows="3" placeholder="Nur intern sichtbar, nicht auf der Rechnung">{{ quote.notes or '' }}</textarea>
        </div>
        <div class="form-group">
            <label>Bemerkungen (auf Rechnung/Angebot)</label>
            <textarea name="public_notes" rows="3" placeholder="Wird auf Angebot, Rechnung und Lieferschein gedruckt">{{ quote.public_notes or '' }}</textarea>
        </div>
        <button type="submit" class="btn btn-primary">Details speichern</button>
    </form>
</div>

<!-- Inventory Items -->
<div class="card quote-section">
    <h2>Inventar-Artikel</h2>
    {% if not quote.start_date or not quote.end_date %}
        <p class="text-warning">&#9888; Bitte setzen Sie Start- und Enddatum, bevor Sie Artikel hinzufÃ¼gen.</p>
    {% else %}
        <form method="POST" class="d-flex gap-10 align-end mb-14">
            <input type="hidden" name="action" value="update_quote">
            <input type="hidden" name="customer_name" value="{{ quote.customer_name }}">
            <input type="hidden" name="start_date" value="{{ quote.start_date.strftime('%Y-%m-%d') if quote.start_date else '' }}">
            <input type="hidden" name="end_date" value="{{ quote.end_date.strftime('%Y-%m-%d') if quote.end_date else '' }}">
            <input type="hidden" name="recipient_lines" value="{{ quote.recipient_lines or '' }}">
            <input type="hidden" name="notes" value="{{ quote.notes or '' }}">
            <input type="hidden" name="public_notes" value="{{ quote.public_notes or '' }}">
            <div class="d-flex gap-6 align-center">
                <span class="text-muted">Mietzeitraum: {{ quote.calculate_rental_days() }} Tag{{ 'e' if quote.calculate_rental_days() != 1 }}{% if quote.rental_days_override %} <strong class="text-accent">(manuell)</strong>{% endif %}</span>
                <label class="text-muted text-sm m-0">â€” Ãœberschreiben:</label>
                <input type="number" name="rental_days_override" value="{{ quote.rental_days_override or '' }}" min="1" step="1" class="w-80" placeholder="â€”">
                <span class="text-muted text-sm">Tage</span>
                <button type="submit" class="btn btn-sm btn-outline">Speichern</button>
            </div>
        </form>

        <!-- Add Item Dropdown -->
        <form method="POST" class="d-flex gap-10 align-end mb-20">
            <input type="hidden" name="action" value="add_item">
            <div class="form-group m-0 flex-1">
                <label>Artikel hinzufÃ¼gen</label>
                <select name="item_id" class="w-full">
                    <option value="">â€” Artikel auswÃ¤hlen â€”</option>
                    {% set existing_ids = quote.quote_items|rejectattr('is_custom')|rejectattr('package_id')|map(attribute='item_id')|list %}
                    {% set existing_package_ids = quote.quote_items|selectattr('package_id')|map(attribute='package_id')|unique|list %}

                    {# Items grouped by category (hierarchical) #}
                    {% for cat, depth in category_tree %}
                        {% set cat_items = items|selectattr('category')|selectattr('category.id', 'equalto', cat.id)|list %}
                        {% if cat_items %}
                        {% set prefix = 'â€”' * depth ~ ' ' if depth > 0 else '' %}
                        <optgroup label="{{ prefix }}{{ cat.name }}">
                            {% for item in cat_items %}
                                {% if item.is_package %}
                                    {% if item.id not in existing_package_ids %}
                                        {% set avail = item_availability.get(item.id, 0) %}
                                        <option value="{{ item.id }}">
                                            {{ 'âš  ' if avail == 0 }}ðŸ“¦ {{ item.name }}
                                            ({{ 'âˆž' if avail == -1 else avail }} verf.)
                                            â€” â‚¬{{ "%.2f"|format(item.default_rental_price_per_day) }}/Tag
                                        </option>
                                    {% endif %}
                                {% elif item.id not in existing_ids %}
                                    {% set avail = item_availability.get(item.id, 0) %}
                                    <option value="{{ item.id }}">
                                        {{ 'âš  ' if avail == 0 }}{{ item.name }}
                                        {% if item.is_external %} â†— Extern{% endif %}
                                        ({{ 'âˆž' if avail == -1 else avail }} verf.)
                                        â€” â‚¬{{ "%.2f"|format(item.default_rental_price_per_day) }}/Tag
                                    </option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                        {% endif %}
                    {% endfor %}

                    {# Items without category #}
                    {% set uncategorized = items|rejectattr('category')|list %}
                    {% if uncategorized %}
                    <optgroup label="Ohne Kategorie">
                        {% for item in uncategorized %}
                            {% if item.is_package %}
                                {% if item.id not in existing_package_ids %}
                                    {% set avail = item_availability.get(item.id, 0) %}
                                    <option value="{{ item.id }}">
                                        {{ 'âš  ' if avail == 0 }}ðŸ“¦ {{ item.name }}
                                        ({{ 'âˆž' if avail == -1 else avail }} verf.)
                                        â€” â‚¬{{ "%.2f"|format(item.default_rental_price_per_day) }}/Tag
                                    </option>
                                {% endif %}
                            {% elif item.id not in existing_ids %}
                                {% set avail = item_availability.get(item.id, 0) %}
                                <option value="{{ item.id }}">
                                    {{ 'âš  ' if avail == 0 }}{{ item.name }}
                                    {% if item.is_external %} â†— Extern{% endif %}
                                    ({{ 'âˆž' if avail == -1 else avail }} verf.)
                                    â€” â‚¬{{ "%.2f"|format(item.default_rental_price_per_day) }}/Tag
                                </option>
                            {% endif %}
                        {% endfor %}
                    </optgroup>
                    {% endif %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary">HinzufÃ¼gen</button>
        </form>

        <!-- Current Items in Quote -->
        {% set inventory_items = quote.quote_items|rejectattr('is_custom')|list %}
        {% set standalone_items = inventory_items|rejectattr('package_id')|list %}
        {% set package_items = inventory_items|selectattr('package_id')|list %}
        {% set package_ids = package_items|map(attribute='package_id')|unique|list %}
        {% if inventory_items %}
        <form method="POST">
            <input type="hidden" name="action" value="update_items">
            <table>
                <thead>
                    <tr>
                        <th>Artikel</th>
                        <th>VerfÃ¼gbar</th>
                        <th>Menge</th>
                        <th>Preis/Tag</th>
                        <th>Kosten/Tag</th>
                        <th>Kein Rabatt</th>
                        <th>Summe</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {# Package grouped items #}
                    {% for pkg_id in package_ids %}
                    {% set pkg_components = package_items|selectattr('package_id', 'equalto', pkg_id)|list %}
                    {% if pkg_components %}
                    {% set pkg = pkg_components[0].package %}
                    <tr class="package-header-row">
                        <td colspan="6">
                            <strong>ðŸ“¦ {{ pkg.name }}</strong>
                            <span class="badge badge-package">Paket</span>
                        </td>
                        <td>
                            &euro;{{ "%.2f"|format(pkg_components|sum(attribute='total_price')) }}
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-danger" title="Ganzes Paket entfernen" onclick="removePackage({{ pkg_id }})">âœ• Paket</button>
                        </td>
                    </tr>
                    {% for qi in pkg_components %}
                    {% set avail = item_availability.get(qi.item_id, 0) %}
                    <tr class="package-component-row{{ ' overstock-row' if avail != -1 and qi.quantity > avail }}">
                        <td class="pl-30">
                            â†³ {{ qi.item.name }}
                            {% if qi.item.is_external %}<br><small class="text-external">&#x2197; Extern</small>{% endif %}
                            {% if qi.item.category %}<br><small class="text-muted">{{ qi.item.category.name }}</small>{% endif %}
                        </td>
                        <td>{{ 'âˆž' if avail == -1 else avail }} / {{ 'âˆž' if qi.item.total_quantity == -1 else qi.item.total_quantity }}{% if avail != -1 and qi.quantity > avail %}<br><small class="text-warning">âš  Ãœberbestand</small>{% endif %}</td>
                        <td><input type="number" name="quantity_pkg_{{ qi.id }}" value="{{ qi.quantity }}" min="0" class="w-80"></td>
                        <td><input type="number" name="price_pkg_{{ qi.id }}" value="{{ '%.2f'|format(qi.rental_price_per_day) }}" step="0.01" min="0" class="w-100"></td>
                        <td>
                            <input type="number" name="cost_pkg_{{ qi.id }}" value="{{ '%.2f'|format(qi.rental_cost_per_day) }}" step="0.01" min="0" class="w-100">
                        </td>
                        <td class="text-center">
                            <label class="exempt-label" title="Vom Rabatt ausgenommen">
                                <input type="checkbox" name="discount_exempt_pkg_{{ qi.id }}" {{ 'checked' if qi.discount_exempt }}>
                            </label>
                        </td>
                        <td>
                            &euro;{{ "%.2f"|format(qi.total_price) }}
                            {% if qi.rental_cost_per_day %}
                                <br><small class="text-danger">Kosten: &euro;{{ "%.2f"|format(qi.total_external_cost) }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-danger" title="Komponente entfernen" onclick="removeQuoteItem({{ qi.id }})">âœ•</button>
                        </td>
                    </tr>
                    {% endfor %}
                    {% endif %}
                    {% endfor %}

                    {# Standalone items (non-package) #}
                    {% for qi in standalone_items %}
                    {% set avail = item_availability.get(qi.item_id, 0) %}
                    <tr class="{{ 'overstock-row' if avail != -1 and qi.quantity > avail }}">
                        <td>
                            <strong>{{ qi.item.name }}</strong>
                            {% if qi.item.is_external %}<br><small class="text-external">&#x2197; Extern</small>{% endif %}
                            {% if qi.item.category %}<br><small class="text-muted">{{ qi.item.category.name }}</small>{% endif %}
                        </td>
                        <td>{{ 'âˆž' if avail == -1 else avail }} / {{ 'âˆž' if qi.item.total_quantity == -1 else qi.item.total_quantity }}{% if avail != -1 and qi.quantity > avail %}<br><small class="text-warning">âš  Ãœberbestand</small>{% endif %}</td>
                        <td><input type="number" name="quantity_{{ qi.item_id }}" value="{{ qi.quantity }}" min="0" class="w-80"></td>
                        <td><input type="number" name="price_{{ qi.item_id }}" value="{{ '%.2f'|format(qi.rental_price_per_day) }}" step="0.01" min="0" class="w-100"></td>
                        <td>
                            <input type="number" name="cost_{{ qi.item_id }}" value="{{ '%.2f'|format(qi.rental_cost_per_day) }}" step="0.01" min="0" class="w-100">
                        </td>
                        <td class="text-center">
                            <label class="exempt-label" title="Vom Rabatt ausgenommen">
                                <input type="checkbox" name="discount_exempt_{{ qi.item_id }}" {{ 'checked' if qi.discount_exempt }}>
                            </label>
                        </td>
                        <td>
                            &euro;{{ "%.2f"|format(qi.total_price) }}
                            {% if qi.rental_cost_per_day %}
                                <br><small class="text-danger">Kosten: &euro;{{ "%.2f"|format(qi.total_external_cost) }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-danger" title="Entfernen" onclick="removeQuoteItem({{ qi.id }})">âœ•</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <button type="submit" class="btn btn-primary">Artikel speichern</button>
        </form>
        {% else %}
            <p class="text-muted mt-10">Noch keine Artikel hinzugefÃ¼gt. Verwenden Sie das Dropdown oben.</p>
        {% endif %}
    {% endif %}
</div>

<!-- Custom Items -->
<div class="card quote-section">
    <h2>Eigene Positionen</h2>
    {% set custom_items = quote.quote_items|selectattr('is_custom')|list %}
    {% if custom_items %}
        <form method="POST">
            <input type="hidden" name="action" value="update_items">
            <table>
                <thead>
                    <tr><th>Name</th><th>Menge</th><th>Preis/Tag</th><th>Kein Rabatt</th><th>Summe</th><th></th></tr>
                </thead>
                <tbody>
                    {% for qi in custom_items %}
                    <tr>
                        <td>{{ qi.custom_item_name }}</td>
                        <td>{{ qi.quantity }}</td>
                        <td>&euro;{{ "%.2f"|format(qi.rental_price_per_day) }}</td>
                        <td class="text-center">
                            <label class="exempt-label" title="Vom Rabatt ausgenommen">
                                <input type="checkbox" name="discount_exempt_custom_{{ qi.id }}" {{ 'checked' if qi.discount_exempt }}>
                            </label>
                        </td>
                        <td>&euro;{{ "%.2f"|format(qi.total_price) }}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-danger" onclick="removeQuoteItem({{ qi.id }})">Entfernen</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <button type="submit" class="btn btn-primary mt-10">Positionen speichern</button>
        </form>
    {% endif %}

    <form method="POST" class="d-flex gap-10 align-end mt-14">
        <input type="hidden" name="action" value="add_custom">
        <div class="form-group m-0 flex-1">
            <label>Name</label>
            <input type="text" name="custom_name" placeholder="z.B. Aufbauzeit">
        </div>
        <div class="form-group m-0 w-100">
            <label>Menge</label>
            <input type="number" name="custom_quantity" value="1" min="1">
        </div>
        <div class="form-group m-0 w-120">
            <label>Preis/Tag</label>
            <input type="number" name="custom_price" step="0.01" min="0">
        </div>
        <button type="submit" class="btn btn-primary">HinzufÃ¼gen</button>
    </form>
</div>

<!-- Pricing Summary -->
<div class="card quote-section">
    <h2>PreisÃ¼bersicht</h2>
    <div class="price-summary">
        <div class="price-row">
            <span>Zwischensumme ({{ quote.calculate_rental_days() }} Tag{{ 'e' if quote.calculate_rental_days() != 1 }})</span>
            <span>&euro;{{ "%.2f"|format(quote.subtotal) }}</span>
        </div>

        <form method="POST" class="mb-10 mt-10">
            <input type="hidden" name="action" value="update_discount">
            <div class="price-row align-center">
                <div class="d-flex gap-8 align-center">
                    <span>Rabatt</span>
                    <input type="text" name="discount_label" value="{{ quote.discount_label or '' }}" placeholder="Bezeichnung (optional)" class="w-200 text-sm">
                </div>
                <div class="d-flex gap-8 align-center">
                    <input type="number" name="final_discount_percent" id="discount_percent" value="{{ '%.4f'|format(quote.discount_percent) }}" step="0.0001" min="0" max="100" class="w-120">
                    <span>%</span>
                </div>
            </div>
            <div class="price-row align-center mt-8">
                <span>oder Gesamtpreis</span>
                <div class="d-flex gap-8 align-center">
                    <span>&euro;</span>
                    <input type="number" name="target_total" id="target_total" value="" step="0.01" min="0" class="w-140" placeholder="{{ '%.2f'|format(quote.total) }}">
                    <button type="submit" class="btn btn-sm btn-outline">Ãœbernehmen</button>
                </div>
            </div>
        </form>

        <script>
        (function() {
            const pctInput = document.getElementById('discount_percent');
            const totalInput = document.getElementById('target_total');
            const subtotal = {{ quote.subtotal }};
            const discountable = {{ quote.discountable_subtotal }};

            pctInput.addEventListener('input', function() {
                if (discountable > 0) {
                    const pct = parseFloat(this.value) || 0;
                    const discount = discountable * (pct / 100);
                    totalInput.value = '';
                    totalInput.placeholder = (subtotal - discount).toFixed(2);
                }
            });
            totalInput.addEventListener('input', function() {
                const target = parseFloat(this.value);
                if (!isNaN(target) && discountable > 0) {
                    const needed = subtotal - target;
                    const pct = Math.max(0, Math.min(100, (needed / discountable) * 100));
                    pctInput.value = pct.toFixed(4);
                }
            });
        })();
        </script>

        {% if quote.discount_percent > 0 %}
        <div class="price-row">
            <span>RabattfÃ¤hig</span>
            <span>&euro;{{ "%.2f"|format(quote.discountable_subtotal) }}</span>
        </div>
        <div class="price-row">
            <span>Rabatt{{ ' â€“ ' + quote.discount_label if quote.discount_label else '' }} ({{ "%.2f"|format(quote.discount_percent) }}%)</span>
            <span>-&euro;{{ "%.2f"|format(quote.discount_amount) }}</span>
        </div>
        {% endif %}

        <div class="price-row total">
            <span>Gesamt</span>
            <span>&euro;{{ "%.2f"|format(quote.total) }}</span>
        </div>
        {% if site_settings and site_settings.tax_mode == 'regular' %}
        {% set mwst_amount = (quote.total - (quote.total / (1 + tax_rate / 100)))|round(2) %}
        <div class="price-row" style="font-size:0.9em;color:var(--color-text-muted);">
            <span>darin enthaltene {{ "%g"|format(tax_rate) }}% MwSt.</span>
            <span>&euro;{{ "%.2f"|format(mwst_amount) }}</span>
        </div>
        {% endif %}
    </div>

    <div class="d-flex gap-10 flex-wrap mt-20">
        {% if quote.finalized_at %}
        <!-- Previous finalization date exists - show warning dialog -->
        <button type="button" class="btn btn-success" onclick="showFinalizeDialog()">Angebot finalisieren</button>
        {% else %}
        <form method="POST" class="d-inline">
            <input type="hidden" name="action" value="finalize">
            <button type="submit" class="btn btn-success" onclick="return confirm('Angebot finalisieren?');">Angebot finalisieren</button>
        </form>
        {% endif %}
        <a href="{{ url_for('admin.quote_list') }}" class="btn btn-outline">ZurÃ¼ck zu Angeboten</a>
        <form method="POST" action="{{ url_for('admin.quote_delete', quote_id=quote.id) }}" class="d-inline" onsubmit="return confirm('Dieses Angebot lÃ¶schen?');">
            <button type="submit" class="btn btn-danger">Angebot lÃ¶schen</button>
        </form>
    </div>

    {% if quote.finalized_at %}
    <div id="finalize-dialog" style="display:none;margin-top:12px;">
        <form method="POST" id="finalize-form">
            <input type="hidden" name="action" value="finalize">
            <p style="margin-bottom:10px;"><strong>âš  Vorheriges Finalisierungsdatum vorhanden</strong></p>
            <p class="text-muted" style="font-size:0.9em;margin-bottom:12px;">Dieses Angebot war zuvor finalisiert ({{ quote.finalized_at.strftime('%d.%m.%Y') }}). MÃ¶chten Sie das bisherige Finalisierungsdatum verwenden oder das heutige Datum?</p>
            <div class="d-flex gap-10 flex-wrap" style="align-items:center;">
                <button type="submit" name="finalized_at" value="{{ quote.finalized_at.strftime('%Y-%m-%d') }}" class="btn btn-success">Bisheriges Datum ({{ quote.finalized_at.strftime('%d.%m.%Y') }})</button>
                <button type="submit" class="btn btn-outline">Heutiges Datum</button>
                <button type="button" class="btn btn-sm btn-outline" onclick="document.getElementById('finalize-dialog').style.display='none'">Abbrechen</button>
            </div>
        </form>
    </div>
    {% endif %}
</div>

<script>
(function() {
    const nameInput = document.getElementById('customer_name');
    const addrInput = document.getElementById('recipient_lines');
    const sugBox = document.getElementById('customer-suggestions');
    const saveBtn = document.getElementById('save-customer-btn');
    const deleteBtn = document.getElementById('delete-customer-btn');
    const feedback = document.getElementById('save-feedback');
    let debounce = null;
    let activeIdx = -1;
    let suggestions = [];

    nameInput.addEventListener('input', function() {
        clearTimeout(debounce);
        const q = this.value.trim();
        if (q.length < 1) { hideSuggestions(); return; }
        debounce = setTimeout(() => fetchSuggestions(q), 200);
    });

    nameInput.addEventListener('keydown', function(e) {
        const items = sugBox.querySelectorAll('div');
        if (!items.length) return;
        if (e.key === 'ArrowDown') { e.preventDefault(); activeIdx = Math.min(activeIdx + 1, items.length - 1); highlight(items); }
        else if (e.key === 'ArrowUp') { e.preventDefault(); activeIdx = Math.max(activeIdx - 1, 0); highlight(items); }
        else if (e.key === 'Enter' && activeIdx >= 0) { e.preventDefault(); selectSuggestion(activeIdx); }
        else if (e.key === 'Escape') { hideSuggestions(); }
    });

    document.addEventListener('click', function(e) {
        if (!sugBox.contains(e.target) && e.target !== nameInput) hideSuggestions();
    });

    function fetchSuggestions(q) {
        fetch('{{ url_for("admin.customer_search") }}?q=' + encodeURIComponent(q))
            .then(r => r.json())
            .then(data => {
                suggestions = data;
                renderSuggestions(data);
            });
    }

    function renderSuggestions(data) {
        sugBox.innerHTML = '';
        activeIdx = -1;
        if (!data.length) { hideSuggestions(); return; }
        data.forEach((c, i) => {
            const d = document.createElement('div');
            d.textContent = c.name;
            d.addEventListener('mousedown', (e) => { e.preventDefault(); selectSuggestion(i); });
            sugBox.appendChild(d);
        });
        sugBox.style.display = 'block';
    }

    function selectSuggestion(idx) {
        const c = suggestions[idx];
        nameInput.value = c.name;
        addrInput.value = c.recipient_lines;
        hideSuggestions();
    }

    function highlight(items) {
        items.forEach((el, i) => el.classList.toggle('active', i === activeIdx));
    }

    function hideSuggestions() { sugBox.style.display = 'none'; activeIdx = -1; }

    if (saveBtn) {
        saveBtn.addEventListener('click', function() {
            const name = nameInput.value.trim();
            if (!name) { feedback.textContent = 'Bitte Kundenname eingeben.'; feedback.style.color = '#dc2626'; return; }
            fetch('{{ url_for("admin.customer_save") }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: name, recipient_lines: addrInput.value})
            })
            .then(r => r.json())
            .then(data => {
                if (data.error) { feedback.textContent = data.error; feedback.style.color = '#dc2626'; }
                else {
                    feedback.textContent = data.action === 'updated' ? 'Kunde aktualisiert!' : 'Kunde gespeichert!';
                    feedback.style.color = '#3ecf8e';
                    deleteBtn.classList.remove('d-none');
                    setTimeout(() => feedback.textContent = '', 3000);
                    // Also save the quote details
                    const quoteForm = saveBtn.closest('form');
                    if (quoteForm) quoteForm.submit();
                }
            })
            .catch(() => { feedback.textContent = 'Fehler beim Speichern.'; feedback.style.color = '#dc2626'; });
        });
    }

    if (deleteBtn) {
        deleteBtn.addEventListener('click', function() {
            const name = nameInput.value.trim();
            if (!name) return;
            if (!confirm('Gespeicherten Kunden "' + name + '" wirklich lÃ¶schen?')) return;
            fetch('{{ url_for("admin.customer_delete") }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: name})
            })
            .then(r => r.json())
            .then(data => {
                if (data.error) { feedback.textContent = data.error; feedback.style.color = '#dc2626'; }
                else {
                    feedback.textContent = 'Kunde gelÃ¶scht.';
                    feedback.style.color = '#3ecf8e';
                    deleteBtn.classList.add('d-none');
                    setTimeout(() => feedback.textContent = '', 3000);
                }
            })
            .catch(() => { feedback.textContent = 'Fehler beim LÃ¶schen.'; feedback.style.color = '#dc2626'; });
        });
    }

    // Check if current customer exists on page load
    function checkCustomerExists() {
        if (!deleteBtn) return;
        const name = nameInput.value.trim();
        if (name.length < 1) { deleteBtn.classList.add('d-none'); return; }
        fetch('{{ url_for("admin.customer_search") }}?q=' + encodeURIComponent(name))
            .then(r => r.json())
            .then(data => {
                if (Array.isArray(data)) {
                    const match = data.find(c => c.name.toLowerCase() === name.toLowerCase());
                    deleteBtn.classList.toggle('d-none', !match);
                }
            })
            .catch(() => {});
    }
    checkCustomerExists();
    nameInput.addEventListener('change', checkCustomerExists);
})();

function removeQuoteItem(quoteItemId) {
    const f = document.createElement('form');
    f.method = 'POST';
    f.style.display = 'none';
    f.innerHTML = '<input name="action" value="remove_item"><input name="quote_item_id" value="' + quoteItemId + '">';
    document.body.appendChild(f);
    f.submit();
}

function removePackage(packageId) {
    if (!confirm('Alle Komponenten dieses Pakets entfernen?')) return;
    const f = document.createElement('form');
    f.method = 'POST';
    f.style.display = 'none';
    f.innerHTML = '<input name="action" value="remove_package"><input name="package_id" value="' + packageId + '">';
    document.body.appendChild(f);
    f.submit();
}

function showFinalizeDialog() {
    document.getElementById('finalize-dialog').style.display = '';
}
</script>
{% endblock %}
