{% extends "admin/base.html" %}

{% block title %}Einstellungen - Verwaltung{% endblock %}

{% block content %}
<h1>Seiteneinstellungen</h1>

<div class="card">
    <form method="POST" enctype="multipart/form-data">
        <h2>Unternehmensinformationen</h2>
        <p class="text-muted mb-16">Wird in PDFs und der öffentlichen Storefront verwendet.</p>

        <div class="form-group">
            <label>Anzeigename / Markenname</label>
            <input type="text" name="display_name" value="{{ settings.display_name or '' }}" placeholder="{{ settings.business_name or '' }}">
            <small class="help-text">Wird auf der Website, im Seitentitel und im Header angezeigt. Wenn leer, wird der Firmenname verwendet.</small>
        </div>

        <div class="form-group">
            <label>Firmenname</label>
            <input type="text" name="business_name" value="{{ settings.business_name or '' }}">
            <small class="help-text">Offizieller Name – erscheint auf PDFs (Rechnungen, Angebote, Lieferscheine).</small>
        </div>

        <div class="form-group">
            <label>Adresszeilen</label>
            <textarea name="address_lines" rows="3" placeholder="Straße&#10;PLZ Stadt&#10;Land">{{ settings.address_lines or '' }}</textarea>
            <small class="help-text">Maximal 4 Zeilen (eine Zeile pro Eingabezeile).</small>
        </div>

        <div class="form-group">
            <label>Kontaktdaten</label>
            <textarea name="contact_lines" rows="3" placeholder="Tel: +49 ...&#10;Email: info@...">{{ settings.contact_lines or '' }}</textarea>
            <small class="help-text">3–5 Zeilen im PDF-Footer, je nachdem ob Steuernummer und/oder USt-IdNr gesetzt sind.</small>
        </div>

        <div class="form-group">
            <label>Bankverbindung</label>
            <textarea name="bank_lines" rows="3" placeholder="Bank: ...&#10;IBAN: ...&#10;BIC: ...">{{ settings.bank_lines or '' }}</textarea>
            <small class="help-text">Maximal 5 Zeilen.</small>
        </div>

        <div class="form-group">
            <label>Steuernummer</label>
            <input type="text" name="tax_number" value="{{ settings.tax_number or '' }}" placeholder="12/345/67890">
            <small class="help-text">Wird auf PDF-Dokumenten angezeigt und in E-Rechnungen (ZUGFeRD) eingebettet.</small>
        </div>

        <div class="form-group">
            <label>USt-IdNr</label>
            <input type="text" name="vat_id" value="{{ settings.vat_id or '' }}" placeholder="DE123456789">
            <small class="help-text">Umsatzsteuer-Identifikationsnummer. F&uuml;r E-Rechnungen (ZUGFeRD) empfohlen.</small>
        </div>

        <div class="form-group">
            <label>Umsatzsteuer-Modus</label>
            <select name="tax_mode" id="tax_mode_select" onchange="toggleTaxRate()">
                <option value="kleinunternehmer" {{ 'selected' if (settings.tax_mode or 'kleinunternehmer') == 'kleinunternehmer' }}>Kleinunternehmer (&sect;19 UStG) &ndash; keine MwSt</option>
                <option value="regular" {{ 'selected' if settings.tax_mode == 'regular' }}>Regul&auml;r &ndash; MwSt ausweisen</option>
            </select>
        </div>

        <div class="form-group{{ '' if settings.tax_mode == 'regular' else ' d-none' }}" id="tax_rate_group">
            <label>MwSt-Satz (%)</label>
            <input type="number" name="tax_rate" step="0.1" min="0" max="100" value="{{ settings.tax_rate if settings.tax_rate is not none else 19.0 }}">
            <small class="help-text">&Uuml;blicher Satz: 19% (oder 7% f&uuml;r erm&auml;&szlig;igte G&uuml;ter)</small>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>Zahlungsziel (Tage)</label>
                <input type="number" name="payment_terms_days" value="{{ settings.payment_terms_days or 14 }}" min="1" max="365">
            </div>
            <div class="form-group">
                <label>Angebots-G&uuml;ltigkeit (Tage)</label>
                <input type="number" name="quote_validity_days" value="{{ settings.quote_validity_days or 14 }}" min="1" max="365">
            </div>
        </div>

        <div class="form-group">
            <label>Firmenlogo</label>
            {% if settings.logo_filename %}
                <div class="mb-8">
                    <img src="{{ url_for('admin.serve_logo') }}" alt="Logo" class="logo-preview">
                    <br>
                    <small class="text-muted">Aktuell: {{ settings.logo_filename }}</small>
                </div>
            {% endif %}
            <input type="file" name="logo" accept="image/png,image/jpeg,image/svg+xml,image/webp,image/gif">
            <small class="help-text">PNG, JPEG, SVG, WebP oder GIF. Wird auf PDFs oben rechts angezeigt.</small>
            {% if settings.logo_filename %}
                <label class="mt-4 font-normal"><input type="checkbox" name="remove_logo" value="1"> Logo entfernen</label>
            {% endif %}
        </div>

        <hr class="section-divider">

        <h2>Öffentlicher Shop</h2>

        <div class="form-group">
            <label>Shop-Beschreibung</label>
            <textarea name="shop_description" rows="2" placeholder="Kurze Beschreibung für die Storefront...">{{ settings.shop_description or '' }}</textarea>
        </div>

        <hr class="section-divider">

        <h2>Rechtliche Links</h2>
        <p class="text-muted mb-16">Diese werden im Footer der öffentlichen Storefront angezeigt.</p>

        <div class="form-row">
            <div class="form-group">
                <label>Impressum-URL</label>
                <input type="url" name="imprint_url" value="{{ settings.imprint_url or '' }}" placeholder="https://...">
            </div>
            <div class="form-group">
                <label>Datenschutz-URL</label>
                <input type="url" name="privacy_url" value="{{ settings.privacy_url or '' }}" placeholder="https://...">
            </div>
        </div>

        <hr class="section-divider">

        <h2>Allgemeine Geschäftsbedingungen (AGB)</h2>
        <p class="text-muted mb-16">Werden dem Angebot als Anlage angehängt. Einfaches Markdown: <code>#</code> für Überschriften, <code>##</code> für Unterüberschriften, Leerzeile für Absätze.</p>

        <div class="form-group">
            <label>AGB-Text</label>
            <textarea name="terms_and_conditions_text" rows="12" placeholder="# Allgemeine Geschäftsbedingungen&#10;&#10;## §1 Geltungsbereich&#10;Diese AGB gelten für...">{{ settings.terms_and_conditions_text or '' }}</textarea>
        </div>

        <hr class="section-divider">

        <h2>Benachrichtigungen</h2>

        <div class="form-group">
            <label>Benachrichtigungs-E-Mail</label>
            <input type="email" name="notification_email" value="{{ settings.notification_email or '' }}" placeholder="Empfängt Anfrage-Benachrichtigungen">
            <small class="help-text">E-Mail-Adresse, die Benachrichtigungen erhält, wenn Kunden Anfragen absenden. SMTP muss über Umgebungsvariablen konfiguriert sein (SMTP_SERVER, SMTP_PORT, SMTP_USER, SMTP_PASSWORD).</small>
        </div>

        <hr class="section-divider">

        <h2>Buchhaltungs-API</h2>
        {% if accounting_configured %}
        <p class="text-muted mb-16">Verbindung konfiguriert über Umgebungsvariablen (ACCOUNTING_API_URL, ACCOUNTING_API_KEY). Wählen Sie die Kategorien und Konten für Einnahmen und Ausgaben.</p>

        <div class="form-row">
            <div class="form-group">
                <label>Einnahmen-Kategorie</label>
                <select name="accounting_income_category_id" id="acct_income_cat">
                    <option value="">— Keine —</option>
                </select>
                <small class="help-text">Kategorie für Zahlungseingänge aus Angeboten.</small>
            </div>
            <div class="form-group">
                <label>Ausgaben-Kategorie</label>
                <select name="accounting_expense_category_id" id="acct_expense_cat">
                    <option value="">— Keine —</option>
                </select>
                <small class="help-text">Kategorie für externe Mietkosten.</small>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Einnahmen-Konto</label>
                <select name="accounting_income_account_id" id="acct_income_acc">
                    <option value="">— Keins —</option>
                </select>
                <small class="help-text">Standard-Konto für Zahlungseingänge (z.B. Bank, Bargeld).</small>
            </div>
            <div class="form-group">
                <label>Ausgaben-Konto</label>
                <select name="accounting_expense_account_id" id="acct_expense_acc">
                    <option value="">— Keins —</option>
                </select>
                <small class="help-text">Standard-Konto für externe Mietkosten.</small>
            </div>
        </div>
        {% else %}
        <p class="text-muted mb-16">Nicht konfiguriert. Setzen Sie die Umgebungsvariablen <code>ACCOUNTING_API_URL</code> und <code>ACCOUNTING_API_KEY</code>, um die Buchhaltungs-Integration zu aktivieren.</p>
        {% endif %}

        <button type="submit" class="btn btn-primary mt-10">Einstellungen speichern</button>
    </form>
</div>

<script>
function toggleTaxRate() {
    var mode = document.getElementById('tax_mode_select').value;
    document.getElementById('tax_rate_group').classList.toggle('d-none', mode !== 'regular');
}

{% if accounting_configured %}
(function() {
    var savedIncomeCat = {{ settings.accounting_income_category_id|default('null', true) }};
    var savedExpenseCat = {{ settings.accounting_expense_category_id|default('null', true) }};
    var savedIncomeAcc = {{ settings.accounting_income_account_id|default('null', true) }};
    var savedExpenseAcc = {{ settings.accounting_expense_account_id|default('null', true) }};

    function loadCategories(type, selectId, savedVal) {
        fetch('{{ url_for("admin.accounting_categories") }}?type=' + type)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var sel = document.getElementById(selectId);
                if (!data.categories) return;
                data.categories.forEach(function(c) {
                    var opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name + (c.description ? ' – ' + c.description : '');
                    if (savedVal !== null && c.id === savedVal) opt.selected = true;
                    sel.appendChild(opt);
                });
            })
            .catch(function(err) { console.error('Fehler beim Laden der Kategorien:', err); });
    }

    function loadAccounts(selectId, savedVal) {
        fetch('{{ url_for("admin.accounting_accounts") }}')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var sel = document.getElementById(selectId);
                if (!data.accounts) return;
                data.accounts.forEach(function(a) {
                    var opt = document.createElement('option');
                    opt.value = a.id;
                    opt.textContent = a.name + (a.description ? ' – ' + a.description : '');
                    if (savedVal !== null && a.id === savedVal) opt.selected = true;
                    sel.appendChild(opt);
                });
            })
            .catch(function(err) { console.error('Fehler beim Laden der Konten:', err); });
    }

    loadCategories('income', 'acct_income_cat', savedIncomeCat);
    loadCategories('expense', 'acct_expense_cat', savedExpenseCat);
    loadAccounts('acct_income_acc', savedIncomeAcc);
    loadAccounts('acct_expense_acc', savedExpenseAcc);
})();
{% endif %}
</script>

{% endblock %}
