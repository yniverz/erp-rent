{% extends "admin/base.html" %}

{% block title %}Einstellungen - Verwaltung{% endblock %}

{% block content %}
<h1>Seiteneinstellungen</h1>

<div class="card">
    <form method="POST" enctype="multipart/form-data">
        <h2>Unternehmensinformationen</h2>
        <p class="text-muted mb-16">Wird in PDFs und der öffentlichen Storefront verwendet.</p>

        <div class="form-group">
            <label>Firmenname</label>
            <input type="text" name="business_name" value="{{ settings.business_name or '' }}">
        </div>

        <div class="form-group">
            <label>Adresszeilen</label>
            <textarea name="address_lines" rows="3" placeholder="Straße&#10;PLZ Stadt&#10;Land">{{ settings.address_lines or '' }}</textarea>
        </div>

        <div class="form-group">
            <label>Kontaktdaten</label>
            <textarea name="contact_lines" rows="3" placeholder="Tel: +49 ...&#10;Email: info@...">{{ settings.contact_lines or '' }}</textarea>
        </div>

        <div class="form-group">
            <label>Bankverbindung</label>
            <textarea name="bank_lines" rows="3" placeholder="Bank: ...&#10;IBAN: ...&#10;BIC: ...">{{ settings.bank_lines or '' }}</textarea>
        </div>

        <div class="form-group">
            <label>Steuernummer / USt-IdNr</label>
            <input type="text" name="tax_number" value="{{ settings.tax_number or '' }}" placeholder="DE123456789 oder 12/345/67890">
        </div>

        <div class="form-group">
            <label>Umsatzsteuer-Modus</label>
            <select name="tax_mode">
                <option value="kleinunternehmer" {{ 'selected' if (settings.tax_mode or 'kleinunternehmer') == 'kleinunternehmer' }}>Kleinunternehmer (&sect;19 UStG) &ndash; keine MwSt</option>
                <option value="regular" {{ 'selected' if settings.tax_mode == 'regular' }}>Regul&auml;r &ndash; 19% MwSt ausweisen</option>
            </select>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>Zahlungsziel (Tage)</label>
                <input type="number" name="payment_terms_days" value="{{ settings.payment_terms_days or 14 }}" min="1" max="365">
            </div>
            <div class="form-group">
                <label>Angebots-G&uuml;ltigkeit (Tage)</label>
                <input type="number" name="quote_validity_days" value="{{ settings.quote_validity_days or 14 }}" min="1" max="365">
            </div>
        </div>

        <div class="form-group">
            <label>Firmenlogo</label>
            {% if settings.logo_filename %}
                <div class="mb-8">
                    <img src="{{ url_for('admin.serve_logo') }}" alt="Logo" style="max-height: 80px; max-width: 300px;">
                    <br>
                    <small class="text-muted">Aktuell: {{ settings.logo_filename }}</small>
                </div>
            {% endif %}
            <input type="file" name="logo" accept="image/png,image/jpeg,image/svg+xml,image/webp,image/gif">
            <small class="help-text">PNG, JPEG, SVG, WebP oder GIF. Wird auf PDFs oben rechts angezeigt.</small>
            {% if settings.logo_filename %}
                <label class="mt-4" style="font-weight:normal;"><input type="checkbox" name="remove_logo" value="1"> Logo entfernen</label>
            {% endif %}
        </div>

        <hr class="section-divider">

        <h2>Öffentlicher Shop</h2>

        <div class="form-group">
            <label>Shop-Beschreibung</label>
            <textarea name="shop_description" rows="2" placeholder="Kurze Beschreibung für die Storefront...">{{ settings.shop_description or '' }}</textarea>
        </div>

        <hr class="section-divider">

        <h2>Rechtliche Links</h2>
        <p class="text-muted mb-16">Diese werden im Footer der öffentlichen Storefront angezeigt.</p>

        <div class="form-row">
            <div class="form-group">
                <label>Impressum-URL</label>
                <input type="url" name="imprint_url" value="{{ settings.imprint_url or '' }}" placeholder="https://...">
            </div>
            <div class="form-group">
                <label>Datenschutz-URL</label>
                <input type="url" name="privacy_url" value="{{ settings.privacy_url or '' }}" placeholder="https://...">
            </div>
        </div>

        <hr class="section-divider">

        <h2>Allgemeine Geschäftsbedingungen (AGB)</h2>
        <p class="text-muted mb-16">Werden dem Angebot als Anlage angehängt. Einfaches Markdown: <code>#</code> für Überschriften, <code>##</code> für Unterüberschriften, Leerzeile für Absätze.</p>

        <div class="form-group">
            <label>AGB-Text</label>
            <textarea name="terms_and_conditions_text" rows="12" placeholder="# Allgemeine Geschäftsbedingungen&#10;&#10;## §1 Geltungsbereich&#10;Diese AGB gelten für...">{{ settings.terms_and_conditions_text or '' }}</textarea>
        </div>

        <hr class="section-divider">

        <h2>Benachrichtigungen</h2>

        <div class="form-group">
            <label>Benachrichtigungs-E-Mail</label>
            <input type="email" name="notification_email" value="{{ settings.notification_email or '' }}" placeholder="Empfängt Anfrage-Benachrichtigungen">
            <small class="help-text">E-Mail-Adresse, die Benachrichtigungen erhält, wenn Kunden Anfragen absenden. SMTP muss über Umgebungsvariablen konfiguriert sein (SMTP_SERVER, SMTP_PORT, SMTP_USER, SMTP_PASSWORD).</small>
        </div>

        <button type="submit" class="btn btn-primary mt-10">Einstellungen speichern</button>
    </form>
</div>

{% if erpnext_enabled %}
<div class="card" id="erpnext-settings">
    <h2>ERPNext Integration</h2>
    <p class="text-muted mb-16">Verbindung über Umgebungsvariablen konfiguriert. Hier werden die Konten für die Buchungssätze festgelegt.</p>

    <div class="mb-16">
        <button type="button" class="btn btn-outline btn-sm" id="test-erpnext-btn" onclick="testErpNextConnection()">Verbindung testen</button>
        <span id="erpnext-test-result" style="margin-left:8px;"></span>
    </div>

    <form method="POST">
        <!-- Hidden fields to preserve all other settings -->
        <input type="hidden" name="business_name" value="{{ settings.business_name or '' }}">
        <input type="hidden" name="address_lines" value="{{ settings.address_lines or '' }}">
        <input type="hidden" name="contact_lines" value="{{ settings.contact_lines or '' }}">
        <input type="hidden" name="bank_lines" value="{{ settings.bank_lines or '' }}">
        <input type="hidden" name="tax_number" value="{{ settings.tax_number or '' }}">
        <input type="hidden" name="tax_mode" value="{{ settings.tax_mode or 'kleinunternehmer' }}">
        <input type="hidden" name="payment_terms_days" value="{{ settings.payment_terms_days or 14 }}">
        <input type="hidden" name="quote_validity_days" value="{{ settings.quote_validity_days or 14 }}">
        <input type="hidden" name="shop_description" value="{{ settings.shop_description or '' }}">
        <input type="hidden" name="imprint_url" value="{{ settings.imprint_url or '' }}">
        <input type="hidden" name="privacy_url" value="{{ settings.privacy_url or '' }}">
        <input type="hidden" name="terms_and_conditions_text" value="{{ settings.terms_and_conditions_text or '' }}">
        <input type="hidden" name="notification_email" value="{{ settings.notification_email or '' }}">

        <div class="form-group">
            <label>Firma (Company)</label>
            <select name="erpnext_company" id="erpnext_company" onchange="loadAccounts()">
                <option value="">— Firma laden... —</option>
            </select>
        </div>

        <div class="form-group">
            <label>Forderungskonto (Debitoren)</label>
            <select name="erpnext_account_receivable" id="erpnext_account_receivable">
                <option value="">— Zuerst Firma auswählen —</option>
            </select>
            <small class="help-text">z.B. 1400 – Forderungen aus Lieferungen und Leistungen</small>
        </div>

        <div class="form-group">
            <label>Erlöskonto</label>
            <select name="erpnext_account_revenue" id="erpnext_account_revenue">
                <option value="">— Zuerst Firma auswählen —</option>
            </select>
            <small class="help-text">z.B. 4400 – Erlöse</small>
        </div>

        <div class="form-group">
            <label>Umsatzsteuerkonto</label>
            <select name="erpnext_account_vat" id="erpnext_account_vat">
                <option value="">— Zuerst Firma auswählen —</option>
            </select>
            <small class="help-text">z.B. 1776 – Umsatzsteuer 19%. Nur bei Steuermodus "Regulär" benötigt.</small>
        </div>

        <div class="form-group">
            <label>Bankkonto</label>
            <select name="erpnext_account_bank" id="erpnext_account_bank">
                <option value="">— Zuerst Firma auswählen —</option>
            </select>
            <small class="help-text">z.B. 1200 – Bank</small>
        </div>

        <button type="submit" class="btn btn-primary mt-10">ERPNext-Einstellungen speichern</button>
    </form>
</div>

<script>
(function() {
    const savedCompany = {{ (settings.erpnext_company or '')|tojson }};
    const savedReceivable = {{ (settings.erpnext_account_receivable or '')|tojson }};
    const savedRevenue = {{ (settings.erpnext_account_revenue or '')|tojson }};
    const savedVat = {{ (settings.erpnext_account_vat or '')|tojson }};
    const savedBank = {{ (settings.erpnext_account_bank or '')|tojson }};

    // Load companies on page load
    loadCompanies();

    function loadCompanies() {
        fetch('{{ url_for("admin.erpnext_companies") }}')
            .then(r => r.json())
            .then(data => {
                if (data.error) { console.error(data.error); return; }
                const sel = document.getElementById('erpnext_company');
                sel.innerHTML = '<option value="">— Firma auswählen —</option>';
                data.forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name;
                    if (name === savedCompany) opt.selected = true;
                    sel.appendChild(opt);
                });
                if (savedCompany) loadAccounts();
            })
            .catch(e => console.error('Fehler beim Laden der Firmen:', e));
    }

    window.loadAccounts = function() {
        const company = document.getElementById('erpnext_company').value;
        if (!company) return;

        const configs = [
            { id: 'erpnext_account_receivable', kind: 'receivable', saved: savedReceivable },
            { id: 'erpnext_account_revenue',    kind: 'revenue',    saved: savedRevenue },
            { id: 'erpnext_account_vat',        kind: 'tax',        saved: savedVat },
            { id: 'erpnext_account_bank',       kind: 'bank',       saved: savedBank },
        ];

        configs.forEach(cfg => {
            fetch(`{{ url_for("admin.erpnext_accounts") }}?company=${encodeURIComponent(company)}&kind=${cfg.kind}`)
                .then(r => r.json())
                .then(data => {
                    if (data.error) { console.error(data.error); return; }
                    const sel = document.getElementById(cfg.id);
                    sel.innerHTML = '<option value="">— Konto auswählen —</option>';
                    data.forEach(acc => {
                        const opt = document.createElement('option');
                        opt.value = acc.name;
                        const label = acc.account_number ? `${acc.account_number} – ${acc.account_name}` : acc.name;
                        opt.textContent = label;
                        if (acc.name === cfg.saved) opt.selected = true;
                        sel.appendChild(opt);
                    });
                })
                .catch(e => console.error(`Fehler beim Laden der Konten (${cfg.kind}):`, e));
        });
    };

    window.testErpNextConnection = function() {
        const resultEl = document.getElementById('erpnext-test-result');
        resultEl.textContent = 'Teste...';
        resultEl.style.color = '';
        fetch('{{ url_for("admin.erpnext_test_connection") }}')
            .then(r => r.json())
            .then(data => {
                resultEl.textContent = data.message;
                resultEl.style.color = data.success ? '#3ecf8e' : '#dc2626';
            })
            .catch(e => {
                resultEl.textContent = 'Fehler: ' + e;
                resultEl.style.color = '#dc2626';
            });
    };
})();
</script>
{% endif %}
{% endblock %}
