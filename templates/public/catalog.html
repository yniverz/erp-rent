{% extends "public/base.html" %}

{% block title %}{{ site_settings.business_name or 'Rental Shop' }} - Catalog{% endblock %}

{% block extra_head %}
<style>
    .catalog-header { margin-bottom: 30px; }
    .catalog-header h1 { font-size: 2em; margin-bottom: 8px; }
    .catalog-header p { color: #6b7280; font-size: 1.05em; }

    .catalog-layout { display: flex; gap: 30px; }

    .sidebar { width: 220px; flex-shrink: 0; }
    .sidebar h3 { font-size: 0.95em; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7280; margin-bottom: 12px; }
    .category-list { list-style: none; }
    .category-list li { margin-bottom: 4px; }
    .category-list a { display: block; padding: 8px 14px; border-radius: 6px; text-decoration: none; color: #374151; font-size: 0.95em; transition: all 0.15s; }
    .category-list a:hover { background: #e5e7eb; }
    .category-list a.active { background: #2563eb; color: white; font-weight: 600; }

    .items-grid { flex: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 24px; align-content: start; }

    .item-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.08); transition: all 0.2s; display: flex; flex-direction: column; }
    .item-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.12); transform: translateY(-2px); }

    .item-image { width: 100%; height: 200px; object-fit: cover; background: #f3f4f6; display: flex; align-items: center; justify-content: center; }
    .item-image img { width: 100%; height: 100%; object-fit: cover; }
    .item-image .placeholder { color: #9ca3af; font-size: 3em; }

    .item-info { padding: 18px; flex: 1; display: flex; flex-direction: column; }
    .item-category-tag { font-size: 0.78em; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
    .item-name { font-size: 1.1em; font-weight: 600; margin-bottom: 6px; color: #111827; }
    .item-description { font-size: 0.88em; color: #6b7280; margin-bottom: 12px; flex: 1; }
    .item-price { font-size: 1.15em; font-weight: 700; color: #059669; margin-bottom: 14px; }
    .item-price.on-request { color: #d97706; font-weight: 600; font-size: 0.95em; }

    .add-to-cart-form { display: flex; gap: 8px; }
    .add-to-cart-form input[type="number"] { width: 70px; text-align: center; padding: 8px; }
    .add-to-cart-form button { flex: 1; }

    .no-items { text-align: center; padding: 60px 20px; color: #6b7280; }
    .no-items h2 { margin-bottom: 10px; }

    @media (max-width: 768px) {
        .catalog-layout { flex-direction: column; }
        .sidebar { width: 100%; }
        .category-list { display: flex; flex-wrap: wrap; gap: 6px; }
        .category-list li { margin-bottom: 0; }
        .items-grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
    }
</style>
{% endblock %}

{% block content %}
<div class="catalog-header">
    <h1>Equipment Rental</h1>
    {% if site_settings and site_settings.shop_description %}
        <p>{{ site_settings.shop_description }}</p>
    {% else %}
        <p>Browse our selection of professional event technology available for rent.</p>
    {% endif %}
</div>

<div class="catalog-layout">
    {% if categories %}
    <div class="sidebar">
        <h3>Categories</h3>
        <ul class="category-list">
            <li><a href="{{ url_for('public.catalog') }}" class="{{ 'active' if not selected_category }}">All Items</a></li>
            {% for cat in categories %}
                <li><a href="{{ url_for('public.catalog', category=cat.id) }}" class="{{ 'active' if selected_category == cat.id }}">{{ cat.name }}</a></li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <div class="items-grid">
        {% if items %}
            {% for item in items %}
            <div class="item-card">
                <div class="item-image">
                    {% if item.image_filename %}
                        <img src="{{ url_for('public.uploaded_file', filename=item.image_filename) }}" alt="{{ item.name }}" loading="lazy">
                    {% else %}
                        <span class="placeholder">&#128247;</span>
                    {% endif %}
                </div>
                <div class="item-info">
                    {% if item.category %}
                        <div class="item-category-tag">{{ item.category.name }}</div>
                    {% endif %}
                    <div class="item-name">{{ item.name }}</div>
                    {% if item.description %}
                        <div class="item-description">{{ item.description[:120] }}{% if item.description|length > 120 %}...{% endif %}</div>
                    {% endif %}
                    {% if item.show_price_publicly %}
                        <div class="item-price">&euro;{{ "%.2f"|format(item.default_rental_price_per_day) }} / day</div>
                    {% else %}
                        <div class="item-price on-request">Price on request</div>
                    {% endif %}
                    <form class="add-to-cart-form" method="POST" action="{{ url_for('public.cart_add') }}" data-ajax-cart>
                        <input type="hidden" name="item_id" value="{{ item.id }}">
                        <input type="number" name="quantity" value="1" min="1" step="{{ item.rental_step }}">
                        <button type="submit" class="btn btn-primary btn-sm">Add to Cart</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="no-items">
                <h2>No items found</h2>
                <p>{% if selected_category %}No items in this category yet.{% else %}No items available at the moment.{% endif %}</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.querySelectorAll('[data-ajax-cart]').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const btn = this.querySelector('button');
        const origText = btn.textContent;
        btn.textContent = 'Added!';
        btn.style.background = '#059669';
        setTimeout(() => { btn.textContent = origText; btn.style.background = ''; }, 1200);

        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(r => r.json())
        .then(data => {
            if (data.cart_count !== undefined) {
                document.getElementById('cart-badge').textContent = data.cart_count;
            }
        })
        .catch(() => {});
    });
});
</script>
{% endblock %}
