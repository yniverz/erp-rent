{% extends "public/base.html" %}

{% block title %}{{ site_settings.business_name or 'Verleih' }} - Katalog{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/public-catalog.css') }}">
{% endblock %}

{% block content %}
<div class="catalog-header">
    <h1>Geräte mieten</h1>
    {% if site_settings and site_settings.shop_description %}
        <p>{{ site_settings.shop_description|nl2br }}</p>
    {% else %}
        <p>Stöbern Sie in unserer Auswahl an professioneller Veranstaltungstechnik zum Mieten.</p>
    {% endif %}
</div>

{% if not show_items %}
{# ===== MAIN PAGE: Sidebar tree + Top-level category cards ===== #}
<div class="catalog-layout">
    <div class="sidebar">
        <h3>Kategorien</h3>
        {% macro render_tree(cats, depth) %}
        <ul class="category-tree{% if depth == 0 %} category-tree-root{% endif %}">
            {% for cat in cats %}
            {% set is_active = (selected_category == cat.id) %}
            {% set is_ancestor = selected_cat and cat.id in (selected_cat.ancestors | map(attribute='id') | list) %}
            {% set has_children = cat.children | length > 0 %}
            <li class="{% if is_active %}active{% endif %}{% if is_ancestor %} ancestor{% endif %}">
                <div class="tree-item">
                    {% if has_children %}
                    <button class="tree-toggle{% if is_active or is_ancestor %} open{% endif %}" onclick="this.classList.toggle('open');this.closest('li').querySelector(':scope > .category-tree').classList.toggle('collapsed')">
                        <span class="toggle-icon">▸</span>
                    </button>
                    {% else %}
                    <span class="tree-spacer"></span>
                    {% endif %}
                    <a href="{{ url_for('public.catalog', category=cat.id) }}" class="{% if is_active %}active{% endif %}">{{ cat.name }}</a>
                </div>
                {% if has_children %}
                    {{ render_tree(cat.children | sort(attribute='display_order,name'), depth + 1) }}
                {% endif %}
            </li>
            {% endfor %}
        </ul>
        {% endmacro %}

        {% set root_cats = categories | selectattr('parent_id', 'none') | sort(attribute='display_order,name') | list %}
        {{ render_tree(root_cats, 0) }}
    </div>

    <div class="main-content-area">
        <div class="category-cards-grid">
            {% for cat in top_level_categories %}
            <a href="{{ url_for('public.catalog', category=cat.id) }}" class="category-card">
                <div class="category-card-image">
                    {% if cat.image_filename %}
                        <img src="{{ url_for('public.uploaded_file', filename=cat.image_filename) }}" alt="{{ cat.name }}" loading="lazy">
                    {% else %}
                        <span class="placeholder">&#128194;</span>
                    {% endif %}
                </div>
                <div class="category-card-info">
                    <div class="category-card-name">{{ cat.name }}</div>
                    {% if cat.children %}
                        <!-- <div class="category-card-sub">{{ cat.children|length }} Unterkategorie{{ 'n' if cat.children|length != 1 }}</div> -->
                    {% endif %}
                </div>
            </a>
            {% endfor %}
            {% if not top_level_categories %}
            <div class="no-items">
                <h2>Keine Kategorien</h2>
                <p>Momentan keine Kategorien verfügbar.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% else %}
{# ===== CATEGORY VIEW: Sidebar tree + items grid ===== #}
<div class="catalog-layout">
    <div class="sidebar">
        <h3>Kategorien</h3>
        {% macro render_tree(cats, depth) %}
        <ul class="category-tree{% if depth == 0 %} category-tree-root{% endif %}">
            {% for cat in cats %}
            {% set is_active = (selected_category == cat.id) %}
            {% set is_ancestor = selected_cat and cat.id in (selected_cat.ancestors | map(attribute='id') | list) %}
            {% set has_children = cat.children | length > 0 %}
            <li class="{% if is_active %}active{% endif %}{% if is_ancestor %} ancestor{% endif %}">
                <div class="tree-item">
                    {% if has_children %}
                    <button class="tree-toggle{% if is_active or is_ancestor %} open{% endif %}" onclick="this.classList.toggle('open');this.closest('li').querySelector(':scope > .category-tree').classList.toggle('collapsed')">
                        <span class="toggle-icon">▸</span>
                    </button>
                    {% else %}
                    <span class="tree-spacer"></span>
                    {% endif %}
                    <a href="{{ url_for('public.catalog', category=cat.id) }}" class="{% if is_active %}active{% endif %}">{{ cat.name }}</a>
                </div>
                {% if has_children %}
                    {{ render_tree(cat.children | sort(attribute='display_order,name'), depth + 1) }}
                {% endif %}
            </li>
            {% endfor %}
        </ul>
        {% endmacro %}

        <ul class="category-tree category-tree-root">
            <li><a href="{{ url_for('public.catalog') }}">← Alle Kategorien</a></li>
        </ul>
        {% set root_cats = categories | selectattr('parent_id', 'none') | sort(attribute='display_order,name') | list %}
        {{ render_tree(root_cats, 0) }}
    </div>

    <div class="items-grid">
        {% if selected_cat %}
            <h2 class="mb-16">{{ selected_cat.name }}</h2>

            {# Show child categories as small cards if they exist #}
            {% if selected_cat.children %}
            <div class="subcategory-chips">
                {% for child in selected_cat.children | sort(attribute='display_order,name') %}
                <a href="{{ url_for('public.catalog', category=child.id) }}" class="subcategory-chip">{{ child.name }}</a>
                {% endfor %}
            </div>
            {% endif %}
        {% endif %}

        {% if items %}
            {% for item in items %}
            <div class="item-card">
                <a href="{{ url_for('public.item_detail', item_id=item.id) }}" class="item-card-link">
                    <div class="item-image">
                        {% if item.image_filename %}
                            <img src="{{ url_for('public.uploaded_file', filename=item.image_filename) }}" alt="{{ item.name }}" loading="lazy">
                        {% else %}
                            <span class="placeholder">&#128247;</span>
                        {% endif %}
                    </div>
                    <div class="item-info">
                        {% if item.category %}
                            <div class="item-category-tag">{{ item.category.name }}</div>
                        {% endif %}
                        {% if item.is_package %}
                            <div class="item-bundle-tag">Paket</div>
                        {% endif %}
                        <div class="item-name">{{ item.name }}</div>
                        {% if item.description %}
                            <div class="item-description">{{ item.description[:120]|nl2br }}{% if item.description|length > 120 %}...{% endif %}</div>
                        {% endif %}
                    </div>
                </a>
                <div class="item-card-footer">
                    {% if item.show_price_publicly %}
                        <div class="item-price">&euro;{{ "%.2f"|format(item.default_rental_price_per_day) }} / Tag</div>
                    {% else %}
                        <div class="item-price on-request">Preis auf Anfrage</div>
                    {% endif %}
                    <form class="add-to-cart-form" method="POST" action="{{ url_for('public.cart_add') }}" data-ajax-cart>
                        <input type="hidden" name="item_id" value="{{ item.id }}">
                        <input type="number" name="quantity" value="1" min="1">
                        <button type="submit" class="btn btn-primary btn-sm">In den Warenkorb</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="no-items">
                <h2>Keine Artikel gefunden</h2>
                <p>Noch keine Artikel in dieser Kategorie.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.querySelectorAll('[data-ajax-cart]').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const btn = this.querySelector('button');
        const origText = btn.textContent;
        btn.textContent = 'Hinzugefügt!';
        btn.style.background = '#059669';
        setTimeout(() => { btn.textContent = origText; btn.style.background = ''; }, 1200);

        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(r => r.json())
        .then(data => {
            if (data.cart_count !== undefined) {
                document.getElementById('cart-badge').textContent = data.cart_count;
            }
        })
        .catch(() => {});
    });
});

// Auto-collapse non-active branches
document.querySelectorAll('.category-tree li').forEach(li => {
    const subtree = li.querySelector(':scope > .category-tree');
    const toggle = li.querySelector(':scope > .tree-item > .tree-toggle');
    if (subtree && toggle && !toggle.classList.contains('open')) {
        subtree.classList.add('collapsed');
    }
});
</script>
{% endblock %}