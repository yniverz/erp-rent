{% extends "public/base.html" %}

{% block title %}{{ site_settings.business_name or 'Verleih' }} - Katalog{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/public-catalog.css') }}">
{% endblock %}

{% block content %}
<div class="catalog-header">
    <h1>Geräte mieten</h1>
    {% if site_settings and site_settings.shop_description %}
        <p>{{ site_settings.shop_description }}</p>
    {% else %}
        <p>Stöbern Sie in unserer Auswahl an professioneller Veranstaltungstechnik zum Mieten.</p>
    {% endif %}
</div>

<div class="catalog-layout">
    {% if categories %}
    <div class="sidebar">
        <h3>Kategorien</h3>
        <ul class="category-list">
            <li><a href="{{ url_for('public.catalog') }}" class="{{ 'active' if not selected_category }}">Alle Artikel</a></li>
            {% for cat in categories %}
                <li><a href="{{ url_for('public.catalog', category=cat.id) }}" class="{{ 'active' if selected_category == cat.id }}">{{ cat.name }}</a></li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <div class="items-grid">
        {% if items %}
            {% for item in items %}
            <div class="item-card">
                <div class="item-image">
                    {% if item.image_filename %}
                        <img src="{{ url_for('public.uploaded_file', filename=item.image_filename) }}" alt="{{ item.name }}" loading="lazy">
                    {% else %}
                        <span class="placeholder">&#128247;</span>
                    {% endif %}
                </div>
                <div class="item-info">
                    {% if item.category %}
                        <div class="item-category-tag">{{ item.category.name }}</div>
                    {% endif %}
                    <div class="item-name">{{ item.name }}</div>
                    {% if item.description %}
                        <div class="item-description">{{ item.description[:120] }}{% if item.description|length > 120 %}...{% endif %}</div>
                    {% endif %}
                    {% if item.show_price_publicly %}
                        <div class="item-price">&euro;{{ "%.2f"|format(item.default_rental_price_per_day) }} / Tag</div>
                    {% else %}
                        <div class="item-price on-request">Preis auf Anfrage</div>
                    {% endif %}
                    <form class="add-to-cart-form" method="POST" action="{{ url_for('public.cart_add') }}" data-ajax-cart>
                        <input type="hidden" name="item_id" value="{{ item.id }}">
                        <input type="number" name="quantity" value="1" min="1" step="{{ item.rental_step }}">
                        <button type="submit" class="btn btn-primary btn-sm">In den Warenkorb</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="no-items">
                <h2>Keine Artikel gefunden</h2>
                <p>{% if selected_category %}Noch keine Artikel in dieser Kategorie.{% else %}Momentan keine Artikel verfügbar.{% endif %}</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.querySelectorAll('[data-ajax-cart]').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const btn = this.querySelector('button');
        const origText = btn.textContent;
        btn.textContent = 'Hinzugefügt!';
        btn.style.background = '#059669';
        setTimeout(() => { btn.textContent = origText; btn.style.background = ''; }, 1200);

        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(r => r.json())
        .then(data => {
            if (data.cart_count !== undefined) {
                document.getElementById('cart-badge').textContent = data.cart_count;
            }
        })
        .catch(() => {});
    });
});
</script>
{% endblock %}
