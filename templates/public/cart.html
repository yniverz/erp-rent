{% extends "public/base.html" %}

{% block title %}Warenkorb - {{ site_settings.business_name or 'Verleih' }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/public-cart.css') }}">
{% endblock %}

{% block content %}
<div class="cart-page">
    <h1>Ihr Warenkorb</h1>

    {% if not cart_items %}
        <div class="cart-empty">
            <h2>Ihr Warenkorb ist leer</h2>
            <p>Stöbern Sie in unserem Katalog, um Geräte für Ihre Veranstaltung zu finden.</p>
            <a href="{{ url_for('public.catalog') }}" class="btn btn-primary mt-16">Katalog durchstöbern</a>
        </div>
    {% else %}
        <form method="POST" action="{{ url_for('public.cart_update') }}">
            <table class="cart-table">
                <thead>
                    <tr>
                        <th>Artikel</th>
                        <th>Preis / Tag</th>
                        <th>Menge</th>
                        <th>Summe / Tag</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for ci in cart_items %}
                    <tr>
                        <td>
                            <div class="item-row">
                                {% if ci.item.image_filename %}
                                    <img src="{{ url_for('public.uploaded_file', filename=ci.item.image_filename) }}" class="item-thumb" alt="">
                                {% endif %}
                                <div>
                                    <strong>{{ ci.item.name }}</strong>
                                    {% if ci.item.is_package %}<span class="badge badge-bundle">Paket</span>{% endif %}
                                    {% if ci.item.category %}<br><small class="text-muted">{{ ci.item.category.name }}</small>{% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if ci.item.show_price_publicly %}
                                &euro;{{ "%.2f"|format(ci.item.default_rental_price_per_day|netto) }}
                            {% else %}
                                <span class="on-request-text">On request</span>
                            {% endif %}
                        </td>
                        <td>
                            <input type="number" name="quantity_{{ ci.item.id }}" value="{{ ci.quantity }}" min="0">
                        </td>
                        <td>
                            {% if ci.line_total is not none %}
                                &euro;{{ "%.2f"|format(ci.line_total|netto) }}
                            {% else %}
                                <span class="on-request-text">Auf Anfrage</span>
                            {% endif %}
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeItem({{ ci.item.id }})">&#10005;</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div class="cart-actions">
                <button type="submit" class="btn btn-outline btn-sm">Mengen aktualisieren</button>
                <a href="{{ url_for('public.catalog') }}" class="btn btn-sm btn-gray">Weiter stöbern</a>
            </div>
        </form>

        <div class="cart-summary">
            <div class="summary-row total">
                <span>Zwischensumme pro Tag</span>
                <span>&euro;{{ "%.2f"|format(subtotal|netto) }}</span>
            </div>
            {% if has_on_request %}
                <div class="summary-note">&#9888; Einige Artikel sind mit "Preis auf Anfrage" gekennzeichnet. Der endgültige Preis wird nach Ihrer Anfrage mitgeteilt.</div>
            {% endif %}
            <p class="help-text mt-8">Die Endsumme hängt vom Mietzeitraum ab und wird nach Prüfung bestätigt.</p>
        </div>

        <div class="inquiry-form">
            <h2>Mietanfrage senden</h2>
            <p class="text-muted mb-20 text-095">Geben Sie Ihre Daten und gewünschten Termine ein. Wir melden uns mit Verfügbarkeit und einem Angebot bei Ihnen.</p>

            <form method="POST" action="{{ url_for('public.submit_inquiry') }}">
                <div class="form-row">
                    <div class="form-group">
                        <label>Ihr Name *</label>
                        <input type="text" name="customer_name" required>
                    </div>
                    <div class="form-group">
                        <label>E-Mail-Adresse *</label>
                        <input type="email" name="customer_email" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Telefonnummer</label>
                        <input type="tel" name="customer_phone">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Gewünschtes Startdatum *</label>
                        <input type="date" name="start_date" id="start_date" required>
                    </div>
                    <div class="form-group">
                        <label>Gewünschtes Enddatum *</label>
                        <input type="date" name="end_date" id="end_date" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Nachricht / Zusätzliche Infos</label>
                    <textarea name="message" placeholder="Erzählen Sie uns von Ihrer Veranstaltung, dem Veranstaltungsort, besonderen Anforderungen..."></textarea>
                </div>
                <div id="inquiry-errors" class="text-danger text-sm mb-12 d-none"></div>
                <button type="submit" class="btn btn-success btn-submit-lg">Anfrage absenden</button>
            </form>
        </div>
    {% endif %}
</div>

<form id="remove-form" method="POST" class="d-none">
</form>
{% endblock %}

{% block extra_js %}
<script>
function removeItem(itemId) {
    const form = document.getElementById('remove-form');
    form.action = '/cart/remove/' + itemId;
    form.submit();
}

(function() {
    // Set min date to today for date inputs
    const today = new Date().toISOString().split('T')[0];
    const startInput = document.getElementById('start_date');
    const endInput = document.getElementById('end_date');

    if (startInput && endInput) {
        startInput.setAttribute('min', today);
        endInput.setAttribute('min', today);

        // When start date changes, update end date min to be >= start date
        startInput.addEventListener('change', function() {
            if (this.value) {
                endInput.setAttribute('min', this.value);
                // If end date is before new start date, clear it
                if (endInput.value && endInput.value < this.value) {
                    endInput.value = '';
                }
            } else {
                endInput.setAttribute('min', today);
            }
        });

        // Form validation on submit
        const inquiryForm = startInput.closest('form');
        if (inquiryForm) {
            inquiryForm.addEventListener('submit', function(e) {
                const errors = [];
                const errDiv = document.getElementById('inquiry-errors');

                const name = this.querySelector('[name="customer_name"]').value.trim();
                const email = this.querySelector('[name="customer_email"]').value.trim();
                const startVal = startInput.value;
                const endVal = endInput.value;

                if (!name) errors.push('Bitte geben Sie Ihren Namen ein.');
                if (!email) errors.push('Bitte geben Sie Ihre E-Mail-Adresse ein.');
                if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) errors.push('Bitte geben Sie eine gültige E-Mail-Adresse ein.');

                if (!startVal) errors.push('Bitte wählen Sie ein Startdatum.');
                if (!endVal) errors.push('Bitte wählen Sie ein Enddatum.');

                if (startVal && startVal < today) errors.push('Das Startdatum muss in der Zukunft liegen.');
                if (endVal && endVal < today) errors.push('Das Enddatum muss in der Zukunft liegen.');
                if (startVal && endVal && endVal < startVal) errors.push('Das Enddatum muss nach dem Startdatum liegen.');

                if (errors.length > 0) {
                    e.preventDefault();
                    errDiv.innerHTML = errors.join('<br>');
                    errDiv.classList.remove('d-none');
                    errDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    errDiv.classList.add('d-none');
                }
            });
        }
    }
})();
</script>
{% endblock %}
